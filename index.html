// --- PARTE 3 ---

window.buscarPersonaEnAlbergue = function() { 
    const t=window.safeVal('buscador-persona').toLowerCase().trim(); const r=window.el('resultados-busqueda'); 
    if(t.length<2){ window.safeHide('resultados-busqueda'); return; } 
    const l=listaPersonasCache.filter(p=>(p.nombre+" "+p.ap1).toLowerCase().includes(t)||(p.docNum||"").toLowerCase().includes(t)); 
    const g=listaGlobalPrefiliacion.filter(p=>(p.nombre+" "+p.ap1).toLowerCase().includes(t)||(p.docNum||"").toLowerCase().includes(t)); 
    r.innerHTML=""; 
    if(l.length===0&&g.length===0) r.innerHTML="<div>No encontrado</div>"; 
    else { 
        l.forEach(p=>{ r.innerHTML+=`<div class="search-item" onclick="window.seleccionarPersona('${p.id}',false)">${p.nombre} ${p.ap1} (Local)</div>`; }); 
        g.forEach(p=>{ r.innerHTML+=`<div class="search-item" onclick="window.seleccionarPersona('${p.id}',true)">${p.nombre} ${p.ap1} (Nube)</div>`; }); 
    } 
    window.safeShow('resultados-busqueda'); 
};

window.seleccionarPersona = function(pid, isGlobal) { 
    if(typeof pid!=='string') pid=pid.id; let p; 
    if(isGlobal) { p=listaGlobalPrefiliacion.find(x=>x.id===pid); personaEnGestionEsGlobal=true; window.safeShow('banner-nube'); window.safeHide('btns-local-actions'); window.safeShow('btns-cloud-actions'); } 
    else { p=listaPersonasCache.find(x=>x.id===pid); personaEnGestionEsGlobal=false; window.safeHide('banner-nube'); window.safeShow('btns-local-actions'); window.safeHide('btns-cloud-actions'); }
    if(!p) return; 
    personaEnGestion=p; prefiliacionEdicionId=p.id; isGlobalEdit=isGlobal; 
    window.safeHide('resultados-busqueda'); window.safeShow('panel-gestion-persona'); 
    window.el('gestion-nombre-titulo').innerText=p.nombre; window.el('gestion-estado').innerText=isGlobal?"EN NUBE":p.estado; window.el('gestion-cama-info').innerText=(p.cama&&!isGlobal)?`Cama: ${p.cama}`:""; 
    window.setVal('edit-nombre',p.nombre); window.setVal('edit-ap1',p.ap1); window.setVal('edit-ap2',p.ap2); window.setVal('edit-tipo-doc',p.tipoDoc); window.setVal('edit-doc-num',p.docNum); window.setVal('edit-fecha',p.fechaNac); window.setVal('edit-tel',p.telefono); 
    const flist=window.el('info-familia-lista'); flist.innerHTML=""; let fam=[]; 
    if(isGlobal) fam=listaGlobalPrefiliacion.filter(x=>x.familiaId===p.familiaId); else fam=listaPersonasCache.filter(x=>x.familiaId===p.familiaId); 
    window.el('info-familia-resumen').innerText=fam.length>1?`Familia (${fam.length})`:"Individual"; 
    fam.forEach(f=>{ if(f.id!==p.id){ flist.innerHTML+=`<div style="padding:10px;border-bottom:1px solid #eee;cursor:pointer;" onclick="window.seleccionarPersona('${f.id}',${isGlobal})"><strong>${f.nombre}</strong><br>${f.docNum||'-'}</div>`; } }); 
    if(!isGlobal) window.setupAutoSave(); 
};

window.guardarCambiosPersona = async function() { if(!personaEnGestion) return; const p=window.getDatosFormulario('edit'); await updateDoc(doc(db,"albergues",currentAlbergueId,"personas",personaEnGestion.id),p); window.registrarLog(personaEnGestion.id,"Edición","Manual"); window.showToast("Guardado"); };
window.darSalidaPersona = async function() { if(!confirm("Dar salida?")) return; const b=writeBatch(db); const pr=doc(collection(db,"pool_prefiliacion")); const md={...personaEnGestion}; delete md.id; md.cama=null; md.estado='espera'; md.fechaSalida=new Date(); b.set(pr,md); b.delete(doc(db,"albergues",currentAlbergueId,"personas",personaEnGestion.id)); await b.commit(); window.showToast("Salida OK"); window.safeHide('panel-gestion-persona'); };

window.verHistorial = async function(pId = null, forceIsGlobal = null, forceAlbId = null) {
    let targetId = pId; let isPool = (forceIsGlobal !== null) ? forceIsGlobal : personaEnGestionEsGlobal; const activeAlbId = forceAlbId || currentAlbergueId;
    if (!targetId && personaEnGestion) targetId = personaEnGestion.id;
    if (pId && forceIsGlobal === null && listaPersonasCache.find(x => x.id === pId)) isPool = false;
    if (!targetId) return;
    let nombrePersona = "Usuario";
    if (personaEnGestion && personaEnGestion.id === targetId) nombrePersona = `${personaEnGestion.nombre} ${personaEnGestion.ap1 || ''}`;
    else if (listaPersonasCache.length > 0) { const found = listaPersonasCache.find(x => x.id === targetId); if (found) nombrePersona = `${found.nombre} ${found.ap1 || ''}`; }
    else if (listaGlobalPrefiliacion.length > 0) { const found = listaGlobalPrefiliacion.find(x => x.id === targetId); if (found) nombrePersona = `${found.nombre} ${found.ap1 || ''}`; }
    const headerEl = window.el('hist-modal-header'); if (headerEl) headerEl.innerText = `Historial de: ${nombrePersona}`;
    window.safeShow('modal-historial'); const content = window.el('historial-content'); content.innerHTML = '<div style="text-align:center"><div class="spinner"></div></div>';
    try {
        let items = [];
        let pathHist = isPool ? collection(db, "pool_prefiliacion", targetId, "historial") : collection(db, "albergues", activeAlbId, "personas", targetId, "historial");
        const snapHist = await getDocs(pathHist); snapHist.forEach(d => { const data = d.data(); items.push({ ...data, type: 'movimiento', id: d.id, sortDate: data.fecha.toDate() }); });
        if (!isPool) {
            let pathInt = collection(db, "albergues", activeAlbId, "personas", targetId, "intervenciones");
            const snapInt = await getDocs(pathInt); snapInt.forEach(d => { const data = d.data(); items.push({ usuario: data.usuario, accion: data.tipo + ": " + data.subtipo, detalle: data.detalle, fecha: data.fecha, type: 'intervencion', rawType: data.tipo, id: d.id, sortDate: data.fecha.toDate() }); });
        }
        items.sort((a, b) => b.sortDate - a.sortDate);
        if (items.length === 0) { content.innerHTML = "<p>No hay registros.</p>"; return; }
        let html = `<div class="hist-timeline">`;
        items.forEach(d => {
            const f = d.sortDate; const fmt = `${f.getDate().toString().padStart(2, '0')}/${(f.getMonth() + 1).toString().padStart(2, '0')}/${f.getFullYear()} ${f.getHours().toString().padStart(2, '0')}:${f.getMinutes().toString().padStart(2, '0')}`;
            let extraClass = '';
            if (d.type === 'intervencion') { if (d.rawType === 'Sanitaria') extraClass = 'hist-type-san'; else if (d.rawType === 'Psicosocial') extraClass = 'hist-type-psi'; else if (d.rawType === 'Entregas') extraClass = 'hist-type-ent'; }
            const icon = d.type === 'intervencion' ? '<i class="fa-solid fa-hand-holding-medical"></i>' : '<i class="fa-solid fa-shoe-prints"></i>';
            html += `<div class="hist-item ${extraClass}"><div class="hist-header"><span class="hist-date"><i class="fa-regular fa-clock"></i> ${fmt}</span><span class="hist-user"><i class="fa-solid fa-user-tag"></i> ${d.usuario}</span></div><span class="hist-action">${icon} ${d.accion}</span>${d.detalle ? `<span class="hist-detail">${d.detalle}</span>` : ''}</div>`;
        });
        html += `</div>`; content.innerHTML = html;
    } catch (e) { content.innerHTML = "Error cargando datos."; window.sysLog("Error historial mixto: " + e.message, "error"); }
};
window.verHistorialObservatorio = function(pId, isGlobal, albId){ window.verHistorial(pId, isGlobal, albId); };

window.cancelarEdicionPref=function(){prefiliacionEdicionId=null;window.limpiarFormulario('man');if(window.el('existing-family-list-ui'))window.el('existing-family-list-ui').innerHTML="";window.safeHide('btn-cancelar-edicion-pref');window.safeHide('btn-ingresar-pref');};
window.adminPrefiliarManual=async function(silent=false){if(silent&&!prefiliacionEdicionId)return;if(prefiliacionEdicionId&&isGlobalEdit){const p=window.getDatosFormulario('man');await updateDoc(doc(db,"pool_prefiliacion",prefiliacionEdicionId),p);window.registrarLog(prefiliacionEdicionId,"Edición Pool","Manual",true);if(!silent){window.showToast("Pool Actualizado");window.cancelarEdicionPref();}return;}const n=window.safeVal('man-nombre');if(!n)return alert("Falta nombre");const fid=new Date().getTime().toString();const t=window.getDatosFormulario('man');t.estado='espera';t.familiaId=fid;t.rolFamilia='TITULAR';t.fechaRegistro=new Date();t.origenAlbergueId=currentAlbergueId;const ref=await addDoc(collection(db,"pool_prefiliacion"),t);window.registrarLog(ref.id,"Alta Staff","Titular",true);for(const f of adminFamiliaresTemp){const refF=await addDoc(collection(db,"pool_prefiliacion"),{...f,estado:'espera',familiaId:fid,rolFamilia:'MIEMBRO',fechaRegistro:new Date(),origenAlbergueId:currentAlbergueId});window.registrarLog(refF.id,"Alta Staff","Familiar",true);}if(!silent){alert("Guardado en Pool Global");window.limpiarFormulario('man');adminFamiliaresTemp=[];if(window.el('admin-lista-familiares-ui'))window.el('admin-lista-familiares-ui').innerHTML="Ninguno.";}};
window.rescatarDeGlobalDirecto = async function() { if (!personaEnGestion || !personaEnGestionEsGlobal) return; if (!confirm(`¿Ingresar a ${personaEnGestion.nombre}?`)) return; try { const familia = listaGlobalPrefiliacion.filter(x => x.familiaId === personaEnGestion.familiaId); const batch = writeBatch(db); for (const member of familia) { const localRef = doc(collection(db, "albergues", currentAlbergueId, "personas")); const memberData = { ...member }; delete memberData.id; memberData.fechaIngresoAlbergue = new Date(); memberData.origenPoolId = member.id; memberData.estado = 'espera'; batch.set(localRef, memberData); batch.delete(doc(db, "pool_prefiliacion", member.id)); const logRef = collection(db, "albergues", currentAlbergueId, "personas", localRef.id, "historial"); batch.set(doc(logRef), { fecha: new Date(), usuario: currentUserData.nombre, accion: "Ingreso desde Nube", detalle: "Rescatado" }); const oldHistSnap = await getDocs(collection(db, "pool_prefiliacion", member.id, "historial")); oldHistSnap.forEach(h => { const newHistRef = doc(logRef); batch.set(newHistRef, h.data()); }); } await batch.commit(); window.sysLog(`Familia ingresada con historial.`, "success"); window.showToast("Ingreso realizado."); window.personaEnGestion = null; window.safeHide('panel-gestion-persona'); window.el('buscador-persona').value = ""; } catch (e) { window.sysLog("Error ingreso: " + e.message, "error"); } };
window.publicoGuardarTodo = async function() { const d = window.getDatosFormulario('pub'); if (!d.nombre) return alert("Falta nombre"); if (!auth.currentUser) { try { await signInAnonymously(auth); } catch (e) {} } let nombreAlb = "Albergue (QR)"; const hAlb = window.el('public-albergue-name'); if(hAlb) nombreAlb = hAlb.innerText; const b = writeBatch(db); const fid = new Date().getTime().toString(); const tRef = doc(collection(db, "pool_prefiliacion")); b.set(tRef, { ...d, familiaId: fid, rolFamilia: 'TITULAR', estado: 'espera', origenAlbergueId: currentAlbergueId, fechaRegistro: new Date() }); const lRef = collection(db, "pool_prefiliacion", tRef.id, "historial"); b.set(doc(lRef), { fecha: new Date(), usuario: "Auto-QR", accion: "Alta en Pool", detalle: `Desde QR ${nombreAlb}` }); listaFamiliaresTemp.forEach(async f => { const fRef = doc(collection(db, "pool_prefiliacion")); b.set(fRef, { ...f, familiaId: fid, rolFamilia: 'MIEMBRO', estado: 'espera', origenAlbergueId: currentAlbergueId, fechaRegistro: new Date() }); }); await b.commit(); window.safeHide('public-form-container'); window.safeShow('public-success-msg'); }

window.conectarListenersBackground = function(id) { if(unsubscribeAlbergueDoc) unsubscribeAlbergueDoc(); unsubscribeAlbergueDoc = onSnapshot(doc(db,"albergues",id), d=>{ if(d.exists()){ currentAlbergueData=d.data(); totalCapacidad=parseInt(currentAlbergueData.capacidad||0); window.actualizarContadores(); } }); };
window.setupAutoSave = function() { const inputsFil = ['edit-nombre','edit-ap1','edit-ap2','edit-doc-num','edit-tel','edit-fecha']; inputsFil.forEach(id => { const el = window.el(id); if(el && !el.dataset.hasAutosave) { el.addEventListener('blur', () => window.guardarCambiosPersona(true)); el.dataset.hasAutosave = "true"; if(id === 'edit-fecha') el.oninput = function() { window.formatearFecha(this); }; } }); const inputsPref = ['man-nombre','man-ap1','man-ap2','man-doc-num','man-tel','man-fecha']; inputsPref.forEach(id => { const el = window.el(id); if(el && !el.dataset.hasAutosave) { el.addEventListener('blur', () => { if(prefiliacionEdicionId) window.adminPrefiliarManual(true); }); el.dataset.hasAutosave = "true"; if(id === 'man-fecha') el.oninput = function() { window.formatearFecha(this); }; } }); };
window.registrarLog=async function(pid,act,det,isPool=false){try{const usuarioLog=currentUserData?currentUserData.nombre:"Auto-QR";let path=isPool?collection(db,"pool_prefiliacion",pid,"historial"):collection(db,"albergues",currentAlbergueId,"personas",pid,"historial");await addDoc(path,{fecha:new Date(),usuario:usuarioLog,accion:act,detalle:det});window.sysLog(`Audit Log (${isPool?'Pool':'Local'}): ${act} - ${det}`,"info");}catch(e){console.error(e);}};
window.confirmarDerivacion = async function() { const m = window.el('derivacion-motivo').value; if(!m) return alert("Motivo?"); await addDoc(collection(db,"derivaciones_pendientes"),{ albergueId: currentAlbergueId, personaId: personaEnGestion.id, personaNombre: personaEnGestion.nombre, tipo: tipoDerivacionActual, motivo: m, fecha: new Date(), estado: 'pendiente' }); window.showToast("Enviado"); window.safeHide('modal-derivacion'); };

// --- INIT ---
window.onload = async () => {
    if(isPublicMode){
        window.safeHide('login-screen');
        window.safeShow('public-register-screen');
        window.safeShow('public-welcome-screen');
        window.safeHide('public-form-container');
        window.safeHide('app-shell'); 
        try {
            await signInAnonymously(auth);
            const docRef = doc(db, "albergues", currentAlbergueId);
            const docSnap = await getDoc(docRef);
            if(docSnap.exists()){
                const d = docSnap.data();
                if(window.el('public-albergue-name')) window.el('public-albergue-name').innerText = d.nombre;
            }
        } catch(e) { console.error("Error init público:", e); alert("Error de conexión con el albergue."); }
    } else {
        const passInput = document.getElementById('login-pass');
        if(passInput) passInput.addEventListener('keypress', e=>{ if(e.key==='Enter') window.iniciarSesion(); });
    }
    const params = new URLSearchParams(window.location.search);
    if(params.get('action') === 'scan') { window.sysLog("Deep Link detectado. Esperando Auth...", "info"); }
};

onAuthStateChanged(auth, async (u) => {
    if(isPublicMode) return;
    if(u){
        window.suscribirNotificacionesGlobales(); // CARGAR GLOBO AL INICIO
        const s = await getDoc(doc(db,"usuarios",u.uid));
        if(s.exists()){
            const d = s.data();
            if (d.activo === false) { window.sysLog("Acceso denegado: Usuario inactivo", "warn"); alert("Este usuario ha sido desactivado por administración."); signOut(auth); return; }
            currentUserData = {...d, uid: u.uid};
            window.sysLog(`Usuario autenticado: ${currentUserData.nombre} (${currentUserData.rol})`, "success");
            window.safeHide('login-screen');
            window.safeShow('app-shell');
            window.configurarDashboard();
            const params = new URLSearchParams(window.location.search);
            if(params.get('action') === 'scan' && params.get('aid') && params.get('pid')) { window.iniciarModoFocalizado(params.get('aid'), params.get('pid')); } else { window.navegar('home'); }
        } else {
            window.sysLog("Usuario fantasma detectado. Restaurando INACTIVO...", "warn");
            await setDoc(doc(db,"usuarios",u.uid), { email: u.email, nombre: u.email.split('@')[0], rol: "observador", activo: false });
            alert("Tu usuario ha sido restaurado pero está INACTIVO por seguridad.\n\nContacta con un administrador para que te active.");
            signOut(auth);
        }
    } else {
        window.sysLog("Esperando inicio de sesión...", "info");
        window.safeHide('app-shell');
        window.safeShow('login-screen');
    }
});
