<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti贸n Albergue - V.10.0.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>

    <div class="version-tag">V.10.0.0</div>

    <div id="login-screen" class="">
        <div class="card">
            <h1 style="color:var(--primary); margin-bottom:10px;"><i class="fa-solid fa-hotel"></i> Acceso</h1>
            <input type="email" id="login-email" placeholder="Correo electr贸nico">
            <input type="password" id="login-pass" placeholder="Contrase帽a">
            <button class="primary" style="width:100%" onclick="iniciarSesion()">Iniciar Sesi贸n</button>
            <p class="forgot-password" onclick="recuperarContrasena()">驴Olvidaste tu contrase帽a?</p>
        </div>
    </div>

    <div id="app-shell" class="hidden">
        <header class="app-header">
            <div class="brand"><i class="fa-solid fa-campground"></i> ALBERGUE PRO</div>
            <div class="user-profile">
                <div class="user-info">
                    <span class="user-name" id="user-name-display">...</span>
                    <span class="user-role" id="user-role-badge">...</span>
                </div>
                <button class="btn-logout" onclick="cerrarSesion()"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </header>

        <nav class="app-nav">
            <div class="nav-item" id="nav-home" onclick="navegar('home')">
                <i class="fa-solid fa-house"></i><span>Inicio</span>
            </div>
            <div class="nav-item" id="nav-users" onclick="navegar('usuarios')">
                <i class="fa-solid fa-users"></i><span>Usuarios</span>
            </div>
            <div class="nav-item" id="nav-albergues" onclick="navegar('gestion-albergues')">
                <i class="fa-solid fa-bed"></i><span>Gesti贸n</span>
            </div>
            <div class="nav-item" id="nav-mto" onclick="navegar('mantenimiento')">
                <i class="fa-solid fa-screwdriver-wrench"></i><span>Mantenimiento</span>
            </div>
            <div class="nav-item disabled"><i class="fa-solid fa-chart-pie"></i><span>Informes</span></div>
        </nav>

        <main class="main-content">
            
            <div id="screen-home" class="hidden">
                <div class="hero-container">
                    <i class="fa-solid fa-campground hero-icon"></i>
                    <h1 class="hero-title">Gesti贸n de Albergue</h1>
                    <p class="hero-subtitle">Sistema integral de control de ocupaci贸n y filiaci贸n</p>
                </div>
            </div>

            <div id="screen-usuarios" class="hidden">
                <div class="card">
                    <div style="display:flex; align-items:center; gap: 20px; margin-bottom:20px;">
                        <h2 style="margin:0;"><i class="fa-solid fa-users-gear"></i> Gesti贸n de Personal</h2>
                        <button class="success" onclick="abrirModalUsuario()" style="padding: 6px 12px; font-size: 0.8rem; border-radius:20px;">
                            <i class="fa-solid fa-plus"></i> Nuevo
                        </button>
                    </div>
                    <div class="row">
                        <input type="text" id="search-user" placeholder=" Buscar por nombre o email..." onkeyup="filtrarUsuarios()">
                    </div>
                    <div id="lista-usuarios-container" class="user-list-grid"></div>
                </div>
            </div>

            <div id="screen-gestion-albergues" class="hidden">
                <div class="card">
                    <h2><i class="fa-solid fa-door-open"></i> Selecci贸n de Albergue</h2>
                    <div id="lista-albergues-activos" class="mto-grid"></div>
                </div>
            </div>

            <div id="screen-mantenimiento" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2><i class="fa-solid fa-tools"></i> Mantenimiento</h2>
                    <div id="container-ver-ocultos" class="hidden">
                        <label class="toggle-switch">
                            <input type="checkbox" class="toggle-input" id="check-ver-ocultos" onchange="window.cargarAlberguesMantenimiento()">
                            <span class="toggle-slider"></span>
                            <span style="font-size:0.9rem; font-weight:600; margin-left:10px;">Mostrar Ocultos</span>
                        </label>
                    </div>
                </div>
                <div id="mto-container" class="mto-grid"></div>
            </div>

            <div id="screen-operativa" class="hidden">
                <div class="card">
                    <div class="sticky-header">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <div><h2 id="app-title" style="margin:0;">Albergue</h2><span class="badge badge-active">Ocupaci贸n: <span id="ocupacion-count">0</span> / <span id="capacidad-total">0</span></span></div>
                            <div class="btn-group-horizontal" style="margin-top:0;">
                                <button class="dark" onclick="abrirModalQR()"><i class="fa-solid fa-qrcode"></i> QR Acceso</button>
                                <button class="primary" onclick="abrirMapaGeneral()"><i class="fa-solid fa-bed"></i> Infograf铆a Camas</button>
                                <button class="secondary" onclick="navegar('gestion-albergues')"><i class="fa-solid fa-right-from-bracket"></i> Salir</button>
                            </div>
                        </div>
                        <div class="tabs" style="margin-bottom:0;">
                            <button id="btn-tab-pref" class="tab-btn active" onclick="cambiarPestana('prefiliacion')"> Prefiliaci贸n</button>
                            <button id="btn-tab-fil" class="tab-btn" onclick="cambiarPestana('filiacion')"> Filiaci贸n</button>
                        </div>
                    </div>

                    <div style="margin-top:25px;">
                        
                        <div id="tab-prefiliacion" class="tab-content active">
                            <div style="border: 2px dashed #cbd5e1; padding: 25px; border-radius: var(--radius);">
                                <h3 style="color:var(--primary);"> Ficha de Ingreso</h3>
                                <div style="background:#e0e7ff; padding:15px; border-radius:8px; margin-bottom:20px;">
                                    <label><i class="fa-solid fa-magnifying-glass"></i> Buscar si ya existe (Evitar duplicados):</label>
                                    <input type="text" id="buscador-pref" placeholder="Nombre, DNI o Tel茅fono..." onkeyup="buscarEnPrefiliacion()" autocomplete="off" style="background:white;">
                                    <div id="resultados-pref" class="search-results"></div>
                                </div>
                                <div id="form-manual-container">
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <h4>Datos del Titular</h4>
                                        <button id="btn-cancelar-edicion-pref" class="secondary hidden" style="font-size:0.7em; padding:4px 8px;" onclick="cancelarEdicionPref()">Cancelar Edici贸n</button>
                                    </div>
                                    <div class="row"><div class="col"><label>Nombre (*)</label><input type="text" id="man-nombre"></div><div class="col"><label>Ap 1</label><input type="text" id="man-ap1"></div><div class="col"><label>Ap 2</label><input type="text" id="man-ap2"></div></div>
                                    <div class="row"><div class="col"><label>Doc</label><select id="man-tipo-doc" onchange="verificarMenor('man')"><option value="DNI">DNI</option><option value="NIE">NIE</option><option value="PASAPORTE">Pasaporte</option><option value="MENOR">MENOR</option></select></div><div class="col"><label>N煤mero</label><input type="text" id="man-doc-num" onblur="validarDocumento('man')"><div id="man-doc-error" class="error-msg">Inv谩lido</div></div></div>
                                    <div class="row"><div class="col"><label>F. Nac</label><input type="tel" id="man-fecha" maxlength="10" oninput="formatearFecha(this)" onblur="validarEdad('man')"></div><div class="col"><label>Tel</label><input type="tel" id="man-tel"></div></div>
                                    <div class="fam-list"><h4><i class="fa-solid fa-people-roof"></i> Miembros</h4><div id="admin-lista-familiares-ui"><p style="color:#999;">Ninguno.</p></div><button class="secondary" onclick="abrirModalFamiliarAdmin()" style="width:100%; margin-top:10px;">+ Miembro</button></div>
                                    <button id="btn-save-pref" class="success" style="width:100%; margin-top:20px;" onclick="adminPrefiliarManual()"> Guardar Nuevo</button>
                                </div>
                            </div>
                        </div>

                        <div id="tab-filiacion" class="tab-content hidden">
                            <div class="row"><div class="col"><label>Buscar</label><input type="text" id="buscador-persona" placeholder="Nombre, DNI..." onkeyup="buscarPersonaEnAlbergue()" autocomplete="off"><div id="resultados-busqueda" class="search-results"></div></div></div>
                            <div id="panel-gestion-persona" class="hidden" style="background:#f8fafc; border:1px solid #cbd5e1; border-radius:var(--radius); padding:25px; margin-top:10px;">
                                <h3 id="gestion-nombre-titulo" style="color:var(--primary);">Nombre</h3>
                                <p style="margin-bottom:15px;">Estado: <span id="gestion-estado" class="badge">...</span> <span id="gestion-cama-info"></span></p>
                                <div class="family-box"><div style="display:flex;justify-content:space-between;align-items:center;"><span id="info-familia-resumen" style="font-weight:bold;">...</span><button class="secondary" style="padding:5px 10px;font-size:0.8rem;" onclick="abrirModalVincularFamilia()"> Unir</button></div><div id="info-familia-lista" style="margin-top:10px;"></div></div>
                                <div class="row"><div class="col"><label>Nombre</label><input type="text" id="edit-nombre"></div><div class="col"><label>Ap 1</label><input type="text" id="edit-ap1"></div><div class="col"><label>Ap 2</label><input type="text" id="edit-ap2"></div></div>
                                <div class="row"><div class="col"><label>Doc</label><select id="edit-tipo-doc" onchange="verificarMenor('edit')"><option value="DNI">DNI</option><option value="NIE">NIE</option><option value="PASAPORTE">Pasaporte</option><option value="MENOR">MENOR</option></select></div><div class="col"><label>Num</label><input type="text" id="edit-doc-num" onblur="validarDocumento('edit')"><div id="edit-doc-error" class="error-msg">Inv谩lido</div></div></div>
                                <div class="row"><div class="col"><label>F. Nac</label><input type="tel" id="edit-fecha" oninput="formatearFecha(this)" maxlength="10" onblur="validarEdad('edit')"></div><div class="col"><label>Tel</label><input type="tel" id="edit-tel"></div></div>
                                <div class="btn-row">
                                    <button id="btn-asignar-cama" class="primary" onclick="abrirSeleccionCama()">Asignar Cama</button>
                                    <button id="btn-guardar-cambios" class="secondary" onclick="guardarCambiosPersona()">Guardar</button>
                                    <button id="btn-liberar-cama" class="warning hidden" onclick="liberarCamaMantener()">Liberar</button>
                                    <button id="btn-regresar-pref" class="danger hidden" onclick="regresarPrefiliacion()">Prefiliaci贸n</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="public-register-screen" class="hidden" style="padding:20px; background:white; min-height:100vh;">
        <div style="max-width:600px; margin:0 auto;" id="public-form-container">
            <h1 style="color:var(--primary); text-align:center; margin-bottom:20px;">Auto-Registro</h1>
            <div class="card">
                <div class="row"><div class="col"><label>Nombre (*)</label><input type="text" id="pub-nombre"></div></div>
                <div class="row"><div class="col"><label>Ap 1</label><input type="text" id="pub-ap1"></div><div class="col"><label>Ap 2</label><input type="text" id="pub-ap2"></div></div>
                <div class="row"><div class="col"><label>Doc</label><select id="pub-tipo-doc" onchange="verificarMenor('pub')"><option value="DNI">DNI</option><option value="NIE">NIE</option><option value="PASAPORTE">Pasaporte</option><option value="MENOR">MENOR</option></select></div><div class="col"><label>Num</label><input type="text" id="pub-doc-num" onblur="validarDocumento('pub')"><div id="pub-doc-error" class="error-msg">Inv谩lido</div></div></div>
                <div class="row"><div class="col"><label>F. Nac</label><input type="tel" id="pub-fecha" placeholder="DD/MM/AAAA" maxlength="10" oninput="formatearFecha(this)" onblur="validarEdad('pub')"><div id="pub-fecha-error" class="error-msg">Error</div></div><div class="col"><label>Tel</label><input type="tel" id="pub-tel"></div></div>
                <div class="fam-list"><h4>Familiares</h4><div id="lista-familiares-ui"><p style="color:#999;">Ninguno.</p></div><button class="secondary" onclick="abrirModalFamiliar()" style="width:100%; margin-top:10px;">+ Familiar</button></div>
                <br><button class="success" style="width:100%; padding:15px;" onclick="publicoGuardarTodo()">ENVIAR</button>
            </div>
        </div>
        <div id="public-success-msg" class="success-screen hidden"><div class="success-icon"><i class="fa-solid fa-circle-check"></i></div><h2>隆Enviado!</h2></div>
    </div>

    <div id="modal-qr" class="modal-overlay hidden"><div class="modal-content" style="text-align:center;"><h3>Escanea para acceder</h3><div id="qrcode-display" style="display:inline-block; margin:20px;"></div><p style="color:#666;">Auto-registro m贸vil.</p><button class="secondary" onclick="document.getElementById('modal-qr').classList.add('hidden')">Cerrar</button></div></div>
    <div id="modal-cama" class="modal-overlay hidden"><div class="modal-content"><h3>Seleccionar Cama</h3><p style="font-size:0.8rem;color:#666;">Verde Borde=Sugerencia | Naranja=Reserva Familia</p><div id="grid-camas" class="bed-grid"></div><button class="secondary" style="margin-top:20px; width:100%" onclick="document.getElementById('modal-cama').classList.add('hidden')">Cancelar</button></div></div>
    <div id="modal-bed-info" class="modal-overlay hidden"><div class="modal-content" style="text-align:center; padding:40px;"><div style="font-size:3rem; color:var(--primary); margin-bottom:10px;"><i class="fa-solid fa-user-check"></i></div><h3 style="color:var(--text-light);">Cama <span id="info-cama-num"></span></h3><h2 id="info-nombre-completo" style="color:var(--primary);"></h2><p><span id="info-telefono"></span></p><div id="info-familia-tag" style="background:var(--warning); color:white; padding:5px 15px; border-radius:20px; font-weight:bold; font-size:0.9rem; display:inline-block;"></div><br><br><button class="secondary" onclick="document.getElementById('modal-bed-info').classList.add('hidden')">Cerrar</button></div></div>
    <div id="modal-vincular-familia" class="modal-overlay hidden" style="z-index: 2000;"><div class="modal-content"><h3>Unir a Familia</h3><input type="text" id="search-vincular" placeholder="Buscar..." onkeyup="buscarParaVincular()" autocomplete="off"><div id="resultados-vincular" class="search-results" style="display:none; max-height:200px;"></div><button class="secondary" style="margin-top:15px; width:100%" onclick="document.getElementById('modal-vincular-familia').classList.add('hidden')">Cancelar</button></div></div>
    <div id="modal-albergue" class="modal-overlay hidden"><div class="modal-content"><h3 id="mto-modal-title">Nuevo</h3><label>Nombre</label><input type="text" id="mto-nombre"><div class="row"><div class="col"><label>Cap</label><input type="number" id="mto-capacidad"></div><div class="col"><label>Cols</label><input type="number" id="mto-columnas" value="8"></div></div><div class="btn-row"><button class="primary" onclick="guardarAlbergue()">Guardar</button><button class="secondary" onclick="document.getElementById('modal-albergue').classList.add('hidden')">Cancelar</button></div></div></div>
    <div id="modal-crear-usuario" class="modal-overlay hidden"><div class="modal-content"><h3 id="user-modal-title">Usuario</h3><label>Nombre</label><input type="text" id="new-user-name"><label>Rol</label><select id="new-user-role"></select><label>Email</label><input type="email" id="new-user-email"><label>Contrase帽a</label><input type="password" id="new-user-pass"><p id="edit-pass-warning" style="display:none;color:orange;font-size:0.8em;">Use reset email.</p><div class="btn-row"><button class="primary" onclick="guardarUsuario()">Guardar</button><button class="secondary" onclick="document.getElementById('modal-crear-usuario').classList.add('hidden')">Cerrar</button></div></div></div>
    
    <div id="modal-add-familiar" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>Familiar</h3>
            <div class="row"><div class="col"><label>Nombre</label><input type="text" id="fam-nombre"></div></div>
            <div class="row"><div class="col"><label>Ap 1</label><input type="text" id="fam-ap1"></div><div class="col"><label>Ap 2</label><input type="text" id="fam-ap2"></div></div>
            <div class="row">
                <div class="col"><label>Doc</label><select id="fam-tipo-doc" onchange="verificarMenor('fam')"><option value="MENOR">MENOR</option><option value="DNI">DNI</option><option value="NIE">NIE</option><option value="PASAPORTE">Pasaporte</option></select></div>
                <div class="col"><label>Num</label><input type="text" id="fam-doc-num" disabled><div id="fam-doc-error" class="error-msg">Inv谩lido</div></div>
            </div>
            <div class="row"><div class="col"><label>F. Nac</label><input type="tel" id="fam-fecha" oninput="formatearFecha(this)" maxlength="10"></div></div>
            <div class="btn-row"><button class="primary" onclick="guardarFamiliarEnLista()">A帽adir</button><button class="secondary" onclick="cerrarModalFamiliar()">Cancelar</button></div>
        </div>
    </div>
    
    <div id="modal-admin-add-familiar" class="modal-overlay hidden"><div class="modal-content"><h3>Miembro</h3><div class="row"><div class="col"><label>Nombre</label><input type="text" id="adm-fam-nombre"></div><div class="col"><label>Ap 1</label><input type="text" id="adm-fam-ap1"></div><div class="col"><label>Ap 2</label><input type="text" id="adm-fam-ap2"></div></div><div class="row"><div class="col"><label>Doc</label><select id="adm-fam-tipo-doc" onchange="verificarMenor('adm-fam')"><option value="DNI">DNI</option><option value="NIE">NIE</option><option value="PASAPORTE">Pasaporte</option><option value="MENOR">MENOR</option></select></div><div class="col"><label>Num</label><input type="text" id="adm-fam-doc-num" onblur="validarDocumento('adm-fam')"><div id="adm-fam-doc-error" class="error-msg">Inv谩lido</div></div></div><div class="row"><div class="col"><label>F. Nac</label><input type="tel" id="adm-fam-fecha" oninput="formatearFecha(this)" maxlength="10"></div><div class="col"><label>Tel</label><input type="tel" id="adm-fam-tel"></div></div><div class="btn-row"><button class="primary" onclick="guardarFamiliarAdmin()">A帽adir</button><button class="secondary" onclick="cerrarModalFamiliarAdmin()">Cancelar</button></div></div></div>

    <script type="module" src="script.js"></script>
</body>
</html>
