<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestión Albergue - Ver.2.7.2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

    <div class="version-tag">Ver.2.7.2</div>
    
    <div id="toast" style="visibility: hidden;">Guardado automático</div>
    <div id="loading-overlay" class="hidden"><div class="spinner"></div><h2 style="color:var(--primary);">Cargando Datos...</h2></div>

    <div id="black-box-overlay" class="hidden">
        <div class="bb-header">
            <span><i class="fa-solid fa-terminal"></i> SYSTEM LOG</span>
            <div><button class="bb-btn" onclick="window.limpiarCajaNegra()">LIMPIAR</button><button class="bb-btn close" onclick="window.toggleCajaNegra()">X</button></div>
        </div>
        <div id="black-box-content"></div>
    </div>

    <div id="login-screen" class="">
        <div class="card">
            <h1 style="color:var(--primary); margin-bottom:20px;"><i class="fa-solid fa-hotel"></i> Acceso</h1>
            <input type="email" id="login-email" placeholder="Correo electrónico">
            <input type="password" id="login-pass" placeholder="Contraseña">
            <button class="primary" style="width:100%" onclick="window.iniciarSesion()">Iniciar Sesión</button>
            <p class="forgot-password" onclick="window.recuperarContrasena()">¿Olvidaste tu contraseña?</p>
        </div>
    </div>

    <div id="app-shell" class="hidden">
        <header class="app-header">
            <div class="brand"><i class="fa-solid fa-campground"></i> ALBERGUE PRO</div>
            <div class="user-profile">
                <div class="user-info">
                    <span class="user-name" id="user-name-display">...</span>
                    <span class="user-role" id="user-role-badge">...</span>
                </div>
                <button id="header-btn-debug" class="btn-icon btn-debug hidden" onclick="window.toggleCajaNegra()"><i class="fa-solid fa-terminal"></i></button>
                <button id="header-btn-users" class="btn-icon hidden" onclick="window.navegar('usuarios')"><i class="fa-solid fa-users-gear"></i></button>
                <button class="btn-icon btn-key" onclick="window.abrirModalCambioPass()"><i class="fa-solid fa-key"></i></button>
                <button class="btn-logout" onclick="window.cerrarSesion()"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </header>

        <nav class="app-nav" style="position: relative;">
            
            <div id="notification-badge-container" class="hidden" onclick="window.gestionarClicGlobo()" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); cursor: pointer; z-index: 100;">
                <div class="notif-icon" style="color: var(--primary); font-size: 1.5rem;"><i class="fa-solid fa-bell"></i></div>
                <div id="notif-count" style="position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; font-size: 0.75rem; font-weight: bold; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">0</div>
            </div>

            <div class="nav-item" id="nav-home" onclick="window.navegar('home')"><i class="fa-solid fa-house"></i><span>Inicio</span></div>
            <div class="nav-item" id="nav-intervencion" onclick="window.navegar('intervencion')"><i class="fa-solid fa-qrcode"></i><span>Intervención</span></div>
            <div class="nav-item" id="nav-albergues" onclick="window.navegar('gestion-albergues')"><i class="fa-solid fa-bed"></i><span>Gestión</span></div>
            <div class="nav-item" id="nav-mto" onclick="window.navegar('mantenimiento')"><i class="fa-solid fa-screwdriver-wrench"></i><span>Mantenimiento</span></div>
            <div class="nav-item" id="nav-obs" onclick="window.navegar('observatorio')"><i class="fa-solid fa-binoculars"></i><span>Observatorio</span></div>
        </nav>

        <main class="main-content">
            <div id="screen-home" class="hidden">
                <div class="hero-container"><i class="fa-solid fa-campground hero-icon"></i><h1 class="hero-title">Te damos la bienvenida</h1><p class="hero-subtitle">Sistema integral de control</p></div>
            </div>
            <div id="screen-intervencion" class="hidden">
                <div class="card" style="text-align:center; min-height: 60vh;">
                    <div id="view-scan-ready" style="margin-top: 20px;">
                        <div id="reader" class="hidden"></div>
                        <div id="scan-placeholder"><i class="fa-solid fa-qrcode" style="font-size: 5rem; color: var(--text-light); margin-bottom: 20px;"></i><h2>Escáner</h2><p style="color:#666;">Registrar acciones.</p></div>
                        <button id="btn-start-camera" class="primary" style="padding:15px;" onclick="window.iniciarEscanerReal()">Activar Cámara</button>
                        <button id="btn-stop-camera" class="danger hidden" onclick="window.detenerEscaner()">Detener</button>
                    </div>
                    <div id="view-scan-result" class="hidden" style="width:100%;">
                        <h3 id="interv-albergue-name" style="color:var(--text-light);">ALBERGUE</h3>
                        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:15px;">
                            <div style="text-align:left;"><h2 id="interv-nombre" style="color:var(--primary);">...</h2><p id="interv-doc">...</p><div style="display:flex; gap:5px;"><span id="interv-estado" class="badge"></span><span id="interv-presencia" class="badge"></span></div></div>
                            <button class="secondary" onclick="window.resetIntervencion()">X</button>
                        </div>
                        <div class="movements-grid"><button class="btn-action-panel btn-entry" onclick="window.registrarMovimiento('entrada')">Entrada</button><button class="btn-action-panel btn-exit-action" onclick="window.registrarMovimiento('salida')">Salida</button></div>
                        <div class="derivations-container"><h4>Derivaciones</h4><div class="derivations-grid"><button class="btn-action-panel btn-derive-psi" onclick="window.abrirModalDerivacion('Psicosocial')">Psico</button><button class="btn-action-panel btn-derive-san" onclick="window.abrirModalDerivacion('Sanitaria')">Sanitario</button><button class="btn-action-panel btn-derive-del" onclick="window.abrirModalDerivacion('Entregas')">Entregas</button></div></div>
                        <div id="btn-exit-focused" class="hidden" style="margin-top:30px;"><button class="secondary" style="width:100%;" onclick="window.salirModoFocalizado()">Salir al Menú</button></div>
                    </div>
                </div>
            </div>
            <div id="screen-usuarios" class="hidden"><div class="card"><h2>Gestión Personal</h2><div class="btn-group-horizontal"><button class="danger" onclick="window.desactivarUsuariosMasivo()">Desactivar Staff</button><button class="success" onclick="window.abrirModalUsuario()">+ Nuevo</button></div><input type="text" id="search-user" placeholder="Buscar..." onkeyup="window.filtrarUsuarios()" style="margin-top:10px;"><div id="lista-usuarios-container" class="user-list-grid"></div></div></div>
            <div id="screen-gestion-albergues" class="hidden"><div class="card"><h2>Selección de Albergue</h2><div id="lista-albergues-activos" class="mto-grid"></div></div></div>
            <div id="screen-mantenimiento" class="hidden"><div style="display:flex; justify-content:space-between;"><h2>Mantenimiento</h2><label class="toggle-switch"><input type="checkbox" class="toggle-input" id="check-ver-ocultos" onchange="window.cargarAlberguesMantenimiento()"><span class="toggle-slider"></span><span>Ocultos</span></label></div><div id="mto-container" class="mto-grid"></div></div>
            <div id="screen-observatorio" class="hidden"><div class="obs-grid"><div class="obs-card"><div class="obs-label">Espera</div><div class="obs-val" id="kpi-espera">0</div></div><div class="obs-card"><div class="obs-label">Alojados</div><div class="obs-val" id="kpi-alojados">0</div></div><div class="obs-card"><div class="obs-label">Libres</div><div class="obs-val" id="kpi-libres">0</div></div><div class="obs-card"><div class="obs-label">% Ocup</div><div class="obs-val" id="kpi-percent">0%</div></div></div><div class="card"><h3>Detalle</h3><div id="obs-list-container"></div></div></div>
            
            <div id="screen-operativa" class="hidden">
                <div class="card">
                    <div class="sticky-header">
                        <div style="display:flex; justify-content:space-between;"><div><h2 id="app-title">...</h2><span id="ocupacion-count">...</span> / <span id="capacidad-total">...</span></div><div class="btn-group-horizontal"><button class="dark" onclick="window.abrirModalQR()">QR</button><button class="primary" onclick="window.abrirMapaGeneral()">Camas</button><button class="secondary" onclick="window.navegar('gestion-albergues')">Salir</button></div></div>
                        <div class="tabs" style="margin-top:10px;">
                            <button id="btn-tab-pref" class="tab-btn tab-btn-pref" onclick="window.cambiarPestana('prefiliacion')">Nube</button>
                            <button id="btn-tab-fil" class="tab-btn tab-btn-fil active" onclick="window.cambiarPestana('filiacion')">Filiación</button>
                            <button id="btn-tab-ent" class="tab-btn tab-btn-ent" onclick="window.cambiarPestana('entregas')">Entregas</button>
                            <button id="btn-tab-san" class="tab-btn tab-btn-san" onclick="window.cambiarPestana('sanitaria')">Sanitaria</button>
                            <button id="btn-tab-psi" class="tab-btn tab-btn-psi" onclick="window.cambiarPestana('psicosocial')">Psico</button>
                        </div>
                    </div>
                    <div style="margin-top:25px;">
                        <div id="tab-filiacion" class="tab-content active"><div class="module-box module-fil"><h3>Gestión Alojados</h3><input type="text" id="buscador-persona" placeholder="Buscar..." onkeyup="window.buscarPersonaEnAlbergue()"><div id="resultados-busqueda" class="search-results hidden"></div></div><div id="panel-gestion-persona" class="hidden" style="background:#f8fafc; padding:20px; border-radius:12px;"><div class="banner-nube hidden" id="banner-nube">EN NUBE</div><h3 id="gestion-nombre-titulo">...</h3><div style="display:flex; gap:5px; margin-bottom:10px;"><span id="gestion-estado" class="badge"></span><strong id="gestion-cama-info"></strong></div><div class="row"><input id="edit-nombre"><input id="edit-ap1"><input id="edit-ap2"></div><div class="row"><select id="edit-tipo-doc"><option>DNI</option><option>NIE</option><option>PASAPORTE</option><option>MENOR</option></select><input id="edit-doc-num"></div><div class="row"><input id="edit-fecha"><input id="edit-tel"></div><div class="btn-group-horizontal" id="btns-local-actions"><button class="dark" onclick="window.verCarnetQR()">Carnet</button><button class="primary" onclick="window.abrirSeleccionCama()">Cama</button><button class="secondary" onclick="window.guardarCambiosPersona()">Guardar</button><button class="warning" onclick="window.liberarCamaMantener()">Liberar</button><button class="btn-exit" onclick="window.darSalidaPersona()">Salida</button><button class="dark" onclick="window.verHistorial()">Historial</button></div><div class="btn-group-horizontal hidden" id="btns-cloud-actions"><button class="success" onclick="window.rescatarDeGlobalDirecto()">INGRESAR</button><button class="primary" onclick="window.abrirSeleccionCama()">INGRESAR + CAMA</button></div><hr><div id="info-familia-lista"></div><button class="secondary" onclick="window.abrirModalVincularFamilia()">Vincular</button></div></div>
                        <div id="tab-prefiliacion" class="tab-content hidden"><div class="module-box module-pref"><h3>Monitor Nube</h3><input type="text" id="buscador-pref" onkeyup="window.buscarEnPrefiliacion()"><div id="resultados-pref" class="search-results hidden"></div><div id="form-manual-container"><input id="man-nombre"><input id="man-ap1"><input id="man-ap2"><div class="row"><select id="man-tipo-doc"><option>DNI</option></select><input id="man-doc-num"></div><input id="man-fecha"><input id="man-tel"><div id="existing-family-list-ui"></div><div id="admin-lista-familiares-ui"></div><button class="secondary" onclick="window.abrirModalFamiliarAdmin()">+ Miembro</button><button class="success" onclick="window.adminPrefiliarManual()" style="width:100%; margin-top:10px;">Guardar Nube</button><button id="btn-cancelar-edicion-pref" class="secondary hidden" onclick="window.cancelarEdicionPref()">Cancelar</button></div></div></div>
                        <div id="tab-entregas" class="tab-content hidden"><div class="module-box module-ent"><h3>Entregas</h3><input id="search-ent" onkeyup="window.buscarParaIntervencion('ent')"><div id="res-ent" class="search-results hidden"></div><div id="form-int-ent" class="hidden inter-form"><h4 id="name-int-ent">...</h4><select id="sel-int-ent"></select><textarea id="det-int-ent"></textarea><div class="btn-row"><button class="secondary" onclick="window.cerrarFormularioIntervencion('ent')">Cancelar</button><button class="success" onclick="window.registrarIntervencion('ent')">Registrar</button><button class="dark" onclick="window.verHistorialIntervencion('ent')">Historial</button></div></div></div></div>
                        <div id="tab-sanitaria" class="tab-content hidden"><div class="module-box module-san"><h3>Sanitaria</h3><input id="search-san" onkeyup="window.buscarParaIntervencion('san')"><div id="res-san" class="search-results hidden"></div><div id="form-int-san" class="hidden inter-form"><h4 id="name-int-san">...</h4><select id="sel-int-san"></select><textarea id="det-int-san"></textarea><div class="btn-row"><button class="secondary" onclick="window.cerrarFormularioIntervencion('san')">Cancelar</button><button class="success" onclick="window.registrarIntervencion('san')">Registrar</button><button class="dark" onclick="window.verHistorialIntervencion('san')">Historial</button></div></div></div></div>
                        <div id="tab-psicosocial" class="tab-content hidden"><div class="module-box module-psi"><h3>Psicosocial</h3><input id="search-psi" onkeyup="window.buscarParaIntervencion('psi')"><div id="res-psi" class="search-results hidden"></div><div id="form-int-psi" class="hidden inter-form"><h4 id="name-int-psi">...</h4><select id="sel-int-psi"></select><textarea id="det-int-psi"></textarea><div class="btn-row"><button class="secondary" onclick="window.cerrarFormularioIntervencion('psi')">Cancelar</button><button class="success" onclick="window.registrarIntervencion('psi')">Registrar</button><button class="dark" onclick="window.verHistorialIntervencion('psi')">Historial</button></div></div></div></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-notificaciones" class="modal-overlay hidden" onclick="if(event.target===this)this.classList.add('hidden')"><div class="modal-content"><span class="close-modal" onclick="document.getElementById('modal-notificaciones').classList.add('hidden')">&times;</span><h3>Derivaciones</h3><div id="lista-notificaciones-content"></div></div></div>
    <div id="modal-derivacion" class="modal-overlay hidden" onclick="if(event.target===this)this.classList.add('hidden')"><div class="modal-content"><h3>Derivar</h3><textarea id="derivacion-motivo" placeholder="Motivo..."></textarea><button class="primary" onclick="window.confirmarDerivacion()">Enviar</button></div></div>
    <div id="modal-cama" class="modal-overlay hidden" onclick="if(event.target===this)window.cerrarMapaCamas()"><div class="modal-content modal-lg"><div id="grid-camas" class="bed-grid"></div></div></div>
    <div id="modal-bed-info" class="modal-overlay hidden" onclick="if(event.target===this)this.classList.add('hidden')"><div class="modal-content modal-lg"><h3 id="info-cama-num"></h3><h2 id="info-nombre-completo"></h2><p id="info-telefono"></p><div id="info-familia-detalle"></div><button id="btn-historial-cama" onclick="window.verHistorial()">Historial</button></div></div>
    <div id="modal-vincular-familia" class="modal-overlay hidden" onclick="if(event.target===this)this.classList.add('hidden')"><div class="modal-content"><input id="search-vincular" onkeyup="window.buscarParaVincular()"><div id="resultados-vincular"></div></div></div>
    <div id="modal-albergue" class="modal-overlay hidden" onclick="if(event.target===this)this.classList.add('hidden')"><div class="modal-content"><input id="mto-nombre"><input id="mto-capacidad"><input id="mto-columnas"><button onclick="window.guardarAlbergue()">Guardar</button><button id="btn-delete-albergue" onclick="window.eliminarAlbergueActual()">Eliminar</button></div></div>
    <div id="modal-crear-usuario" class="modal-overlay hidden" onclick="if(event.target===this)this.classList.add('hidden')"><div class="modal-content"><input id="new-user-name"><select id="new-user-role"></select><input id="new-user-email"><input id="new-user-pass" type="password"><input type="checkbox" id="new-user-active"><button onclick="window.guardarUsuario()">Guardar</button><button id="btn-delete-user" onclick="window.eliminarUsuario()">Borrar</button></div></div>
    <div id="modal-change-pass" class="modal-overlay hidden" onclick="if(event.target===this)this.classList.add('hidden')"><div class="modal-content"><input id="chg-old-pass"><input id="chg-new-pass"><input id="chg-confirm-pass"><button onclick="window.ejecutarCambioPass()">Cambiar</button></div></div>
    <div id="modal-historial" class="modal-overlay hidden" onclick="if(event.target===this)this.classList.add('hidden')"><div class="modal-content"><h3 id="hist-modal-header"></h3><div id="historial-content"></div></div></div>
    <div id="modal-add-familiar" class="modal-overlay hidden"><div class="modal-content"><input id="fam-nombre"><input id="fam-ap1"><input id="fam-ap2"><select id="fam-tipo-doc" onchange="window.verificarMenor('fam')"><option>MENOR</option><option>DNI</option></select><input id="fam-doc-num"><input id="fam-fecha"><button onclick="window.guardarFamiliarEnLista()">Añadir</button><button onclick="window.cerrarModalFamiliar()">Cerrar</button></div></div>
    <div id="modal-admin-add-familiar" class="modal-overlay hidden"><div class="modal-content"><input id="adm-fam-nombre"><input id="adm-fam-ap1"><input id="adm-fam-ap2"><select id="adm-fam-tipo-doc" onchange="window.verificarMenor('adm-fam')"><option>MENOR</option><option>DNI</option></select><input id="adm-fam-doc-num"><input id="adm-fam-fecha"><input id="adm-fam-tel"><button onclick="window.guardarFamiliarAdmin()">Añadir</button><button onclick="window.cerrarModalFamiliarAdmin()">Cerrar</button></div></div>
    <div id="modal-obs-detalle" class="modal-overlay hidden" onclick="if(event.target===this)this.classList.add('hidden')"><div class="modal-content modal-lg"><h3 id="obs-modal-title"></h3><div id="obs-modal-content"></div></div></div>
    <div id="modal-qr" class="modal-overlay hidden" onclick="if(event.target===this)this.classList.add('hidden')"><div class="modal-content"><div id="qrcode-display"></div></div></div>
    <div id="modal-carnet-qr" class="modal-overlay hidden" onclick="if(event.target===this)this.classList.add('hidden')"><div class="modal-content"><div id="carnet-qrcode-display"></div><h2 id="carnet-nombre"></h2><p id="carnet-id"></p></div></div>
    
    <div id="public-register-screen" class="hidden"><div id="public-welcome-screen" class="card"><h2 id="public-albergue-name"></h2><input type="checkbox" id="check-consent" onchange="window.toggleStartButton()"><button id="btn-start-public" disabled onclick="window.iniciarRegistro()">Empezar</button></div><div id="public-form-container" class="hidden"><input id="pub-nombre"><input id="pub-ap1"><input id="pub-ap2"><select id="pub-tipo-doc" onchange="window.verificarMenor('pub')"><option>DNI</option></select><input id="pub-doc-num"><input id="pub-fecha"><input id="pub-tel"><div id="lista-familiares-ui"></div><button onclick="window.abrirModalFamiliar()">+ Fam</button><button onclick="window.publicoGuardarTodo()">Enviar</button></div><div id="public-success-msg" class="hidden"><h1>OK</h1></div></div>

    <script type="module" src="script.js"></script>
</body>
</html>
