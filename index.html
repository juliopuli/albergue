<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Albergue - V.5.1.0 (Fix Mantenimiento)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #f4f6f8; color: #333; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h1, h2, h3, h4 { color: #2c3e50; margin-top: 0; }
        
        /* Inputs & Buttons */
        input, button, select { width: 100%; padding: 12px; margin-top: 5px; margin-bottom: 15px; box-sizing: border-box; border-radius: 8px; border: 1px solid #dfe6e9; font-size: 16px; }
        input:focus, select:focus { border-color: #3498db; outline: none; box-shadow: 0 0 5px rgba(52,152,219,0.3); }
        .input-error { border-color: #e74c3c !important; background-color: #fdf0ed; }
        .error-msg { color: #e74c3c; font-size: 0.85em; margin-top: -10px; margin-bottom: 10px; display: none; }
        label { font-weight: 600; font-size: 0.9em; color: #555; display: block; margin-top: 5px;}

        button { background-color: #3498db; color: white; border: none; cursor: pointer; font-weight: 600; transition: transform 0.1s; margin-top: 10px; }
        button:hover { background-color: #2980b9; transform: translateY(-1px); }
        button.secondary { background-color: #95a5a6; }
        button.success { background-color: #2ecc71; }
        button.danger { background-color: #e74c3c; }
        button.warning { background-color: #f39c12; color: white; }
        .btn-group-horizontal { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        .btn-group-horizontal button { flex: 1; min-width: 120px; margin-top: 0; }

        .hidden { display: none !important; }
        .row { display: flex; gap: 15px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 200px; } 
        
        /* Tabs */
        .tabs { display: flex; background: #e9ecef; padding: 5px; border-radius: 10px; margin-bottom: 20px; gap: 5px; }
        .tab-btn { flex: 1; padding: 12px; cursor: pointer; font-weight: bold; color: #666; border: none; background: transparent; border-radius: 8px; margin: 0; transition: all 0.2s ease; }
        .tab-btn.active { background-color: #ffffff; color: #3498db; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-content { display: none; animation: fadeIn 0.3s; } .tab-content.active { display: block; }

        /* Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .dash-btn { background: white; padding: 30px; border-radius: 15px; text-align: center; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 2px solid transparent; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; }
        .dash-btn:hover { transform: translateY(-5px); border-color: #3498db; }
        .dash-icon { font-size: 3em; margin-bottom: 15px; }
        .disabled-btn { opacity: 0.5; cursor: not-allowed; pointer-events: none; filter: grayscale(1); }

        /* MANTENIMIENTO CARDS */
        .mto-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .mto-card { background: white; border: 1px solid #eee; border-radius: 10px; padding: 20px; position: relative; transition: box-shadow 0.2s; display: flex; flex-direction: column; justify-content: space-between; }
        .mto-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .mto-card h3 { margin-bottom: 10px; color: #2980b9; }
        .mto-info { font-size: 0.9em; color: #666; margin-bottom: 15px; }
        .mto-card.archived { opacity: 0.7; background: #f8f9fa; }
        .mto-add-card { border: 2px dashed #3498db; display: flex; align-items: center; justify-content: center; cursor: pointer; background: #f0f8ff; min-height: 200px; }
        .mto-add-card:hover { background: #e1f0ff; }

        /* Search Results */
        .search-results { max-height: 250px; overflow-y: auto; border: 1px solid #eee; margin-top: -16px; margin-bottom: 20px; background: white; display: none; border-radius: 0 0 8px 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .search-item { padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 0.95em; }
        .search-item:hover { background: #e3f2fd; }
        .search-details { font-size: 0.85em; color: #666; margin-left: 5px; }

        /* List & Badges */
        .list-item { background: white; border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; }
        .badge-active { background: #d4edda; color: #155724; }
        .badge-archived { background: #f8d7da; color: #721c24; }
        .role-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; margin-left: 10px; }
        .role-super_admin { background: #8e44ad; color: white; } .role-admin { background: #c0392b; color: white; } .role-avanzado { background: #f39c12; color: white; } .role-medio { background: #16a085; color: white; }

        /* Bed Grid System */
        .bed-grid { display: grid; gap: 10px; margin-top: 20px; }
        .bed-box { height: 60px; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 8px; cursor: pointer; font-weight: bold; border: 2px solid transparent; transition: all 0.2s; position: relative; }
        .bed-free { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .bed-busy { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; opacity: 0.8; }
        .bed-current { background-color: #fff3cd; border-color: #ffeeba; }
        .bed-shadow { background-color: #ffe0b2 !important; border: 2px dashed #fb8c00 !important; color: #e65100; opacity: 0.9; }
        .bed-shadow::after { content: "Reserva"; font-size: 0.55em; position: absolute; bottom: 2px; }
        .bed-suggest-block { border: 3px solid #2ecc71 !important; box-shadow: 0 0 10px rgba(46, 204, 113, 0.5); transform: scale(1.05); }
        .bed-suggest-target { border: 4px solid #2ecc71 !important; box-shadow: 0 0 15px rgba(46, 204, 113, 0.8); transform: scale(1.1); z-index: 10; }
        .bed-suggest-target::after { content: "¬°AQU√ç!"; font-weight:900; color:#27ae60; bottom: -15px; background:white; padding:0 3px; border-radius:4px; font-size:0.7em;}

        /* Modals & Others */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 600px; padding: 30px; border-radius: 12px; max-height: 85vh; overflow-y: auto; }
        .version-tag { position: fixed; bottom: 10px; right: 10px; background: rgba(0, 0, 0, 0.05); color: #999; padding: 5px 10px; border-radius: 5px; font-size: 0.75em; pointer-events: none; font-family: monospace; }
        .fam-list { margin-top: 10px; border-top: 2px dashed #eee; padding-top: 10px; }
        .fam-item { background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .family-box { background: #e3f2fd; border: 1px solid #90caf9; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .success-screen { text-align: center; padding: 50px 20px; } .success-icon { font-size: 4em; color: #2ecc71; margin-bottom: 20px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>

    <div class="version-tag">V.5.1.0 (Fix Mantenimiento)</div>

    <div id="login-screen" style="max-width: 400px; margin: 50px auto;" class="card">
        <h1 style="text-align:center;">üîê Acceso</h1>
        <label>Correo:</label> <input type="email" id="login-email">
        <label>Contrase√±a:</label> <input type="password" id="login-pass">
        <button onclick="iniciarSesion()">Entrar</button>
    </div>

    <div id="dashboard-screen" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div><h2>Hola, <span id="user-name-display">Usuario</span></h2><span id="user-role-badge" class="role-badge">...</span></div>
            <button class="danger" onclick="cerrarSesion()" style="width:auto; padding:8px 20px;">Salir</button>
        </div>
        <div class="dashboard-grid">
            <div id="btn-gest-usuarios" class="dash-btn" onclick="navegar('usuarios')"><div class="dash-icon">üë•</div><div class="dash-title">Usuarios</div></div>
            <div id="btn-gest-albergues" class="dash-btn" onclick="navegar('gestion-albergues')"><div class="dash-icon">üè•</div><div class="dash-title">Albergues</div></div>
            <div id="btn-mantenimiento" class="dash-btn" onclick="navegar('mantenimiento')"><div class="dash-icon">üõ†Ô∏è</div><div class="dash-title">Mantenimiento</div></div>
            <div class="dash-btn disabled-btn"><div class="dash-icon">üìä</div><div class="dash-title">Informes</div></div>
        </div>
    </div>

    <div id="screen-usuarios" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;"><h3>üë• Usuarios</h3><button class="secondary" onclick="navegar('dashboard')" style="width:auto;">Volver</button></div>
        <div class="row"><input type="text" id="search-user" placeholder="Buscar..." onkeyup="filtrarUsuarios()"><button class="success" onclick="abrirCrearUsuario()" style="width:auto;">+ Nuevo</button></div>
        <div id="lista-usuarios-container"></div>
    </div>

    <div id="screen-gestion-albergues" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;"><h3>üè• Selecci√≥n de Albergue</h3><button class="secondary" onclick="navegar('dashboard')" style="width:auto;">Volver</button></div>
        <div id="lista-albergues-activos"></div>
    </div>

    <div id="screen-mantenimiento" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;"><h3>üõ†Ô∏è Mantenimiento</h3><button class="secondary" onclick="navegar('dashboard')" style="width:auto;">Volver</button></div>
        
        <div id="mto-container" class="mto-grid">
            </div>
    </div>

    <div id="screen-operativa" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 id="app-title">Albergue</h3>
            <div style="background:#e9ecef; padding:5px 15px; border-radius:20px; font-weight:bold; color:#555;">üõèÔ∏è <span id="ocupacion-count">0</span> / <span id="capacidad-total">0</span></div>
            <button onclick="navegar('gestion-albergues')" style="width:auto; background:#6c757d; padding:5px 15px;">Salir</button>
        </div>
        <div class="tabs">
            <button id="btn-tab-pref" class="tab-btn active" onclick="cambiarPestana('prefiliacion')">üìÅ Prefiliaci√≥n</button>
            <button id="btn-tab-fil" class="tab-btn" onclick="cambiarPestana('filiacion')">üìÅ Filiaci√≥n</button>
        </div>
        
        <div id="tab-prefiliacion" class="tab-content active">
            <div style="max-width: 800px; margin: 0 auto; border: 1px solid #eee; padding: 20px; border-radius: 8px;">
                <h3 style="color:#2c3e50;">üìù Ficha Completa (Titular + Familia)</h3>
                <div id="form-manual-container">
                    <h4 style="border-bottom:1px solid #eee; padding-bottom:5px;">Datos del Titular</h4>
                    <div class="row"><div class="col"><label>Nombre:</label><input type="text" id="man-nombre"></div><div class="col"><label>Ap. 1:</label><input type="text" id="man-ap1"></div><div class="col"><label>Ap. 2:</label><input type="text" id="man-ap2"></div></div>
                    <div class="row"><div class="col"><label>Doc:</label><select id="man-tipo-doc" onchange="verificarMenor('man')"><option value="DNI">DNI</option><option value="NIE">NIE</option><option value="PASAPORTE">Pasaporte</option><option value="MENOR">MENOR</option></select></div><div class="col"><label>Num:</label><input type="text" id="man-doc-num" onblur="validarDocumento('man')"><div id="man-doc-error" class="error-msg">Inv√°lido</div></div></div>
                    <div class="row"><div class="col"><label>F. Nac:</label><input type="tel" id="man-fecha" maxlength="10" oninput="formatearFecha(this)" onblur="validarEdad('man')"></div><div class="col"><label>Tel:</label><input type="tel" id="man-tel"></div></div>
                    
                    <div class="fam-list"><h4>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Miembros</h4><div id="admin-lista-familiares-ui"><p style="color:#999; font-style:italic;">Ning√∫n familiar a√±adido.</p></div><button class="secondary" onclick="abrirModalFamiliarAdmin()" style="width:100%; margin-top:10px;">‚ûï A√±adir Miembro</button></div>
                    <button class="success" style="width:100%; margin-top:20px; font-size:1.1em;" onclick="adminPrefiliarManual()">üíæ Guardar Todo</button>
                </div>
                <hr style="margin: 30px 0;"><details><summary style="cursor:pointer; color:#007bff; font-weight:bold;">üì≤ QR P√∫blico</summary><div id="qrcode" style="background:white; padding:10px; text-align:center; margin-top:10px;"></div></details>
            </div>
        </div>

        <div id="tab-filiacion" class="tab-content">
            <div class="row"><div class="col"><h4>üîç Buscar</h4><input type="text" id="buscador-persona" placeholder="Nombre/DNI..." onkeyup="buscarPersonaEnAlbergue()" autocomplete="off"><div id="resultados-busqueda" class="search-results"></div></div></div>
            <div id="panel-gestion-persona" class="hidden" style="border: 2px solid #3498db; border-radius: 8px; padding: 20px; background: #fdfdfd; margin-top: 10px;">
                <h3 id="gestion-nombre-titulo" style="color:#2c3e50;">Nombre</h3>
                <p>Estado: <span id="gestion-estado" class="badge">...</span> <span id="gestion-cama-info"></span></p>
                <div class="family-box"><span id="info-familia-actual" style="font-size:0.95em; color:#333;"><strong>Unidad Familiar:</strong> Cargando...</span><button class="secondary" style="margin:0; font-size:0.85em; padding:8px 12px; width:auto; background:#fff; border:1px solid #ccc; color:#333;" onclick="abrirModalVincularFamilia()">üîó Unir a Familia</button></div>
                <div class="row"><div class="col"><label>Nombre:</label><input type="text" id="edit-nombre"></div><div class="col"><label>Ap. 1:</label><input type="text" id="edit-ap1"></div><div class="col"><label>Ap. 2:</label><input type="text" id="edit-ap2"></div></div>
                <div class="row"><div class="col"><label>Doc:</label><select id="edit-tipo-doc" onchange="verificarMenor('edit')"><option value="DNI">DNI</option><option value="NIE">NIE</option><option value="PASAPORTE">Pasaporte</option><option value="MENOR">MENOR</option></select></div><div class="col"><label>Num:</label><input type="text" id="edit-doc-num" onblur="validarDocumento('edit')"><div id="edit-doc-error" class="error-msg">Inv√°lido</div></div></div>
                <div class="row"><div class="col"><label>F. Nac:</label><input type="tel" id="edit-fecha" oninput="formatearFecha(this)" maxlength="10" onblur="validarEdad('edit')"><div id="edit-fecha-error" class="error-msg">Error</div></div><div class="col"><label>Tel:</label><input type="tel" id="edit-tel"></div></div>
                <div class="btn-group-horizontal"><button id="btn-asignar-cama" class="success" onclick="abrirSeleccionCama()">üõèÔ∏è Asignar Cama</button><button id="btn-guardar-cambios" class="secondary" onclick="guardarCambiosPersona()">üíæ Guardar</button><button id="btn-liberar-cama" class="warning hidden" onclick="liberarCamaMantener()">üõå Liberar</button><button id="btn-regresar-pref" class="danger hidden" onclick="regresarPrefiliacion()">üîô Prefiliaci√≥n</button></div>
            </div>
        </div>
        <hr style="margin-top: 30px;"><button class="secondary" style="width:100%; padding:15px; font-size:1.1em; background:#34495e;" onclick="abrirMapaGeneral()">üõèÔ∏è Ver Mapa General de Camas</button>
    </div>

    <div id="public-register-screen" class="card hidden" style="max-width:600px; margin:20px auto;">
        <div id="public-form-container">
            <h2 style="color: #007bff; text-align:center;">üìù Auto-Registro (Familia)</h2>
            <div class="row"><div class="col"><label>Nombre:</label><input type="text" id="pub-nombre"></div></div>
            <div class="row"><div class="col"><label>Primer Apellido:</label><input type="text" id="pub-ap1"></div><div class="col"><label>Segundo Apellido:</label><input type="text" id="pub-ap2"></div></div>
            <div class="row"><div class="col"><label>Documento:</label><select id="pub-tipo-doc" onchange="verificarMenor('pub')"><option value="DNI">DNI</option><option value="NIE">NIE</option><option value="PASAPORTE">Pasaporte</option><option value="MENOR">MENOR</option></select></div><div class="col"><label>N√∫mero:</label><input type="text" id="pub-doc-num" onblur="validarDocumento('pub')"><div id="pub-doc-error" class="error-msg">Inv√°lido</div></div></div>
            <div class="row"><div class="col"><label>F. Nacimiento:</label><input type="tel" id="pub-fecha" placeholder="DD/MM/AAAA" maxlength="10" oninput="formatearFecha(this)" onblur="validarEdad('pub')"><div id="pub-fecha-error" class="error-msg">Error</div></div><div class="col"><label>Tel√©fono:</label><input type="tel" id="pub-tel"></div></div>
            <div class="fam-list"><h4>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familiares</h4><div id="lista-familiares-ui"><p style="color:#999; font-style:italic;">Ninguno a√±adido.</p></div><button class="secondary" onclick="abrirModalFamiliar()" style="width:100%; margin-top:10px;">‚ûï A√ëADIR FAMILIAR</button></div>
            <hr style="margin:20px 0;"><button class="success" style="width:100%; padding:15px; font-size:1.1em;" onclick="publicoGuardarTodo()">‚úÖ ENVIAR TODO EL GRUPO</button>
        </div>
        <div id="public-success-msg" class="success-screen hidden"><div class="success-icon">‚úÖ</div><h2>¬°Datos Enviados!</h2><p>Gracias.</p></div>
    </div>

    <div id="modal-cama" class="modal-overlay hidden"><div class="modal-content"><h3>Seleccionar Cama</h3><div id="grid-camas" class="bed-grid"></div><button onclick="document.getElementById('modal-cama').classList.add('hidden')" class="secondary" style="margin-top:15px;">Cancelar</button></div></div>
    <div id="modal-crear-usuario" class="modal-overlay hidden"><div class="modal-content"><h3>Nuevo Usuario</h3><input type="email" id="new-user-email" placeholder="Correo"><input type="password" id="new-user-pass" placeholder="Contrase√±a"><input type="text" id="new-user-name" placeholder="Nombre"><label>Rol:</label><select id="new-user-role"></select><button class="success" onclick="crearUsuario()">Crear</button><button class="secondary" onclick="document.getElementById('modal-crear-usuario').classList.add('hidden')">Cerrar</button></div></div>
    <div id="modal-add-familiar" class="modal-overlay hidden"><div class="modal-content"><h3>A√±adir Familiar</h3><div class="row"><div class="col"><label>Nombre:</label><input type="text" id="fam-nombre"></div></div><div class="row"><div class="col"><label>Ap. 1:</label><input type="text" id="fam-ap1"></div><div class="col"><label>Ap. 2:</label><input type="text" id="fam-ap2"></div></div><div class="row"><div class="col"><label>Doc:</label><select id="fam-tipo-doc" onchange="verificarMenor('fam')"><option value="MENOR">MENOR</option><option value="DNI">DNI</option><option value="NIE">NIE</option><option value="PASAPORTE">Pasaporte</option></select></div><div class="col"><label>Num:</label><input type="text" id="fam-doc-num" disabled></div></div><div class="row"><div class="col"><label>F. Nac:</label><input type="tel" id="fam-fecha" oninput="formatearFecha(this)" maxlength="10"></div></div><div class="btn-group-horizontal"><button class="success" onclick="guardarFamiliarEnLista()">A√±adir</button><button class="secondary" onclick="cerrarModalFamiliar()">Cancelar</button></div></div></div>
    <div id="modal-admin-add-familiar" class="modal-overlay hidden"><div class="modal-content"><h3>A√±adir Miembro (Admin)</h3><div class="row"><div class="col"><label>Nombre:</label><input type="text" id="adm-fam-nombre"></div><div class="col"><label>Ap. 1:</label><input type="text" id="adm-fam-ap1"></div><div class="col"><label>Ap. 2:</label><input type="text" id="adm-fam-ap2"></div></div><div class="row"><div class="col"><label>Doc:</label><select id="adm-fam-tipo-doc" onchange="verificarMenor('adm-fam')"><option value="DNI">DNI</option><option value="NIE">NIE</option><option value="PASAPORTE">Pasaporte</option><option value="MENOR">MENOR</option></select></div><div class="col"><label>Num:</label><input type="text" id="adm-fam-doc-num" onblur="validarDocumento('adm-fam')"><div id="adm-fam-doc-error" class="error-msg">Inv√°lido</div></div></div><div class="row"><div class="col"><label>F. Nac:</label><input type="tel" id="adm-fam-fecha" oninput="formatearFecha(this)" maxlength="10" onblur="validarEdad('adm-fam')"><div id="adm-fam-fecha-error" class="error-msg">Error</div></div><div class="col"><label>Tel:</label><input type="tel" id="adm-fam-tel"></div></div><div class="btn-group-horizontal"><button class="success" onclick="guardarFamiliarAdmin()">A√±adir a la lista</button><button class="secondary" onclick="cerrarModalFamiliarAdmin()">Cancelar</button></div></div></div>
    <div id="modal-vincular-familia" class="modal-overlay hidden" style="z-index: 2000;"><div class="modal-content"><h3>üîó Unir a Familia</h3><p style="font-size:0.9em; color:#666;">Busca a un familiar registrado:</p><input type="text" id="search-vincular" placeholder="Buscar..." onkeyup="buscarParaVincular()" autocomplete="off"><div id="resultados-vincular" class="search-results" style="display:none; max-height:200px; border:1px solid #ccc;"></div><button class="secondary" style="margin-top:15px;" onclick="document.getElementById('modal-vincular-familia').classList.add('hidden')">Cancelar</button></div></div>
    
    <div id="modal-albergue" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="mto-modal-title">Nuevo Albergue</h3>
            <label>Nombre:</label> <input type="text" id="mto-nombre">
            <div class="row">
                <div class="col"><label>Capacidad:</label><input type="number" id="mto-capacidad"></div>
                <div class="col"><label>Columnas (Forma):</label><input type="number" id="mto-columnas" value="8"></div>
            </div>
            <div class="btn-group-horizontal"><button class="success" onclick="guardarAlbergue()">Guardar</button><button class="secondary" onclick="document.getElementById('modal-albergue').classList.add('hidden')">Cancelar</button></div>
        </div>
    </div>

    <div id="modal-bed-info" class="modal-overlay hidden"><div class="modal-content" style="text-align:center;"><h3 style="color:#2c3e50;">üõèÔ∏è Cama <span id="info-cama-num"></span></h3><hr style="border:0; border-top:1px solid #eee; margin:15px 0;"><h2 id="info-nombre-completo" style="color:#3498db; margin:10px 0; font-size:1.5em;"></h2><p style="font-size:1.2em;"><strong>üìû Tel√©fono:</strong> <span id="info-telefono" style="color:#555;"></span></p><div id="info-familia-tag" style="margin-top:15px; display:inline-block; padding:5px 15px; background:#f39c12; color:white; border-radius:20px; font-weight:bold; font-size:0.9em;"></div><br><br><button class="secondary" onclick="document.getElementById('modal-bed-info').classList.add('hidden')">Cerrar</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, query, where, getDocs, doc, updateDoc, onSnapshot, orderBy, deleteDoc, getDoc } 
        from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAzfEMwMd6M1VgvV0tJn7RS63RJghLE5UI", authDomain: "albergues-temporales.firebaseapp.com", projectId: "albergues-temporales", storageBucket: "albergues-temporales.firebasestorage.app", messagingSenderId: "489999184108", appId: "1:489999184108:web:32b9b580727f83158075c9" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

        let currentUserData=null, currentAlbergueId=null, currentAlbergueData=null, totalCapacidad=0, ocupacionActual=0, camasOcupadas={}, listaPersonasCache=[];
        let unsubscribeUsers, unsubscribeAlberguesActivos, unsubscribeAlberguesMto, unsubscribeDetalleAlbergue, unsubscribePersonas;
        window.personaSeleccionadaId=null; window.personaEnGestion=null; window.modoCambioCama=false; window.modoMapaGeneral=false;
        let listaFamiliaresTemp=[], adminFamiliaresTemp=[];
        let albergueEdicionId = null;

        // --- AUTH & COMMON ---
        window.formatearFecha=(i)=>{let v=i.value.replace(/\D/g,'').slice(0,8);if(v.length>=5)i.value=`${v.slice(0,2)}/${v.slice(2,4)}/${v.slice(4)}`;else if(v.length>=3)i.value=`${v.slice(0,2)}/${v.slice(2)}`;else i.value=v;};
        window.verificarMenor=(p)=>{const t=document.getElementById(`${p}-tipo-doc`).value;const i=document.getElementById(`${p}-doc-num`);if(t==='MENOR'){i.value="MENOR-SIN-DNI";i.disabled=true;i.classList.remove('input-error');if(document.getElementById(`${p}-doc-error`))document.getElementById(`${p}-doc-error`).style.display='none';}else{i.disabled=false;if(i.value==="MENOR-SIN-DNI")i.value="";}};
        window.validarEdad=(p)=>{const f=document.getElementById(`${p}-fecha`).value;const e=document.getElementById(`${p}-fecha-error`);const t=document.getElementById(`${p}-tipo-doc`).value;if(f.length!==10){if(e)e.style.display='none';return true;}const [d,m,a]=f.split('/').map(Number);const nac=new Date(a,m-1,d);const hoy=new Date();let ed=hoy.getFullYear()-nac.getFullYear();if(hoy<new Date(hoy.getFullYear(),m-1,d))ed--;if(t==='MENOR'&&ed>=16){if(e){e.innerText=">16 requiere DNI";e.style.display='block';}return false;}if(e)e.style.display='none';return true;};
        window.validarDocumento=(p)=>{const t=document.getElementById(`${p}-tipo-doc`).value;const i=document.getElementById(`${p}-doc-num`);const e=document.getElementById(`${p}-doc-error`);if(t==='MENOR'||!i.value)return true;let v=i.value.toUpperCase();i.value=v;let ok=true;if(t==='PASAPORTE')ok=v.length>3;else{const l="TRWAGMYFPDXBNJZSQVHLCKE";let n=v;let letIn=v.slice(-1);if(t==='NIE'){if(v.startsWith('X'))n='0'+v.slice(1);else if(v.startsWith('Y'))n='1'+v.slice(1);else if(v.startsWith('Z'))n='2'+v.slice(1);else ok=false;}if(ok){const num=parseInt(n.slice(0,-1));if(isNaN(num))ok=false;else{if(l[num%23]!==letIn)ok=false;}}}if(!ok){i.classList.add('input-error');if(e)e.style.display='block';return false;}else{i.classList.remove('input-error');if(e)e.style.display='none';return true;}};
        
        window.onload=()=>{const p=new URLSearchParams(window.location.search);if(p.get('public_id')){currentAlbergueId=p.get('public_id');document.getElementById('login-screen').classList.add('hidden');document.getElementById('public-register-screen').classList.remove('hidden');}};
        window.iniciarSesion=async()=>{try{await signInWithEmailAndPassword(auth,document.getElementById('login-email').value,document.getElementById('login-pass').value);}catch(e){alert(e.message);}};
        window.cerrarSesion=()=>{signOut(auth);location.reload();};
        onAuthStateChanged(auth,async(u)=>{if(u){const s=await getDoc(doc(db,"usuarios",u.uid));if(s.exists()){currentUserData={...s.data(),uid:u.uid};navegar('dashboard');}}else if(document.getElementById('public-register-screen').classList.contains('hidden'))navegar('login');});
        
        window.navegar=(p)=>{['login-screen','dashboard-screen','screen-usuarios','screen-gestion-albergues','screen-mantenimiento','screen-operativa'].forEach(id=>document.getElementById(id).classList.add('hidden'));if(unsubscribeUsers)unsubscribeUsers();if(unsubscribeAlberguesActivos)unsubscribeAlberguesActivos();if(unsubscribeAlberguesMto)unsubscribeAlberguesMto();if(unsubscribePersonas)unsubscribePersonas();if(p==='login')document.getElementById('login-screen').classList.remove('hidden');else if(p==='dashboard'){configurarDashboard();document.getElementById('dashboard-screen').classList.remove('hidden');}else if(p==='usuarios'){cargarUsuarios();document.getElementById('screen-usuarios').classList.remove('hidden');}else if(p==='gestion-albergues'){cargarAlberguesActivos();document.getElementById('screen-gestion-albergues').classList.remove('hidden');}else if(p==='mantenimiento'){cargarAlberguesMantenimiento();document.getElementById('screen-mantenimiento').classList.remove('hidden');}else if(p==='operativa')document.getElementById('screen-operativa').classList.remove('hidden');};
        function configurarDashboard(){document.getElementById('user-name-display').innerText=currentUserData.nombre;const r=currentUserData.rol;document.getElementById('user-role-badge').innerText=r.toUpperCase();document.getElementById('user-role-badge').className=`role-badge role-${r}`;const u=document.getElementById('btn-gest-usuarios'),m=document.getElementById('btn-mantenimiento');if(['super_admin','admin'].includes(r))u.classList.remove('disabled-btn');else u.classList.add('disabled-btn');if(['super_admin','admin','avanzado'].includes(r))m.classList.remove('disabled-btn');else m.classList.add('disabled-btn');}

        // --- MANTENIMIENTO ---
        function cargarAlberguesMantenimiento(){
            const c=document.getElementById('mto-container');
            unsubscribeAlberguesMto=onSnapshot(query(collection(db,"albergues"),orderBy("nombre")),s=>{
                c.innerHTML="";
                // 1. ADD CARD
                const addDiv=document.createElement('div'); addDiv.className="mto-card mto-add-card"; addDiv.onclick=()=>abrirModalAlbergue();
                addDiv.innerHTML=`<div style="text-align:center; color:#3498db;"><span style="font-size:3em;">‚ûï</span><h3>Nuevo Albergue</h3></div>`;
                c.appendChild(addDiv);
                // 2. ITEMS
                s.forEach(d=>{
                    const a=d.data(); const l=a.columnas?`${a.columnas} cols`: "Auto"; const arch=!a.activo;
                    const div=document.createElement('div'); div.className=`mto-card ${arch?'archived':''}`;
                    div.innerHTML=`<div><h3>${a.nombre}</h3><div class="mto-info">üõèÔ∏è Cap: <strong>${a.capacidad}</strong><br>üìê <strong>${l}</strong><br>${arch?'<span class="badge badge-archived">Archivado</span>':'<span class="badge badge-active">Activo</span>'}</div></div><div class="btn-group-horizontal"><button class="secondary" onclick="abrirModalAlbergue('${d.id}')">‚úèÔ∏è Editar</button><button class="${arch?'success':'danger'}" onclick="cambiarEstadoAlbergue('${d.id}',${!a.activo})">${arch?'Activar':'Archivar'}</button></div>`;
                    c.appendChild(div);
                });
            });
        }
        window.abrirModalAlbergue=async(id=null)=>{
            albergueEdicionId=id; document.getElementById('modal-albergue').classList.remove('hidden');
            if(id){ document.getElementById('mto-modal-title').innerText="Editar"; const s=await getDoc(doc(db,"albergues",id)); const d=s.data(); document.getElementById('mto-nombre').value=d.nombre; document.getElementById('mto-capacidad').value=d.capacidad; document.getElementById('mto-columnas').value=d.columnas||8; }
            else{ document.getElementById('mto-modal-title').innerText="Nuevo"; document.getElementById('mto-nombre').value=""; document.getElementById('mto-capacidad').value=""; document.getElementById('mto-columnas').value="8"; }
        };
        window.guardarAlbergue=async()=>{
            const n=document.getElementById('mto-nombre').value; const c=parseInt(document.getElementById('mto-capacidad').value); const cols=parseInt(document.getElementById('mto-columnas').value)||8;
            if(!n||!c)return alert("Faltan datos");
            if(albergueEdicionId) await updateDoc(doc(db,"albergues",albergueEdicionId),{nombre:n,capacidad:c,columnas:cols});
            else await addDoc(collection(db,"albergues"),{nombre:n,capacidad:c,columnas:cols,activo:true,fecha:new Date()});
            document.getElementById('modal-albergue').classList.add('hidden');
        };
        window.cambiarEstadoAlbergue=async(i,s)=>await updateDoc(doc(db,"albergues",i),{activo:s});

        // --- OPERATIVA & FAMILIA ---
        window.entrarAlbergue=(id)=>{
            currentAlbergueId=id;navegar('operativa');
            onSnapshot(doc(db,"albergues",id),d=>{ currentAlbergueData=d.data(); document.getElementById('app-title').innerText=currentAlbergueData.nombre; totalCapacidad=currentAlbergueData.capacidad||0; actualizarContadores(); generarQR(); });
            unsubscribePersonas=onSnapshot(query(collection(db,"albergues",id,"personas"),orderBy("fechaRegistro","desc")),s=>{
                listaPersonasCache=[]; let c=0; camasOcupadas={};
                s.forEach(ds=>{ const p=ds.data(); p.id=ds.id; listaPersonasCache.push(p); if(p.estado!=='espera'){ c++; if(p.cama) camasOcupadas[p.cama]=p.nombre; } });
                ocupacionActual=c; actualizarContadores();
                if(window.personaEnGestion){ const upd=listaPersonasCache.find(u=>u.id===window.personaEnGestion.id); if(upd) seleccionarPersona(upd); }
            });
        };
        function actualizarContadores(){document.getElementById('ocupacion-count').innerText=ocupacionActual;document.getElementById('capacidad-total').innerText=totalCapacidad;}

        // ... (Funciones Familiares y Buscador igual que V4.3) ...
        window.cambiarPestana=(t)=>{document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));if(t==='prefiliacion'){document.getElementById('btn-tab-pref').classList.add('active');document.getElementById('tab-prefiliacion').classList.add('active');limpiarFormulario('man');adminFamiliaresTemp=[];actualizarListaFamiliaresAdminUI();document.getElementById('panel-gestion-persona').classList.add('hidden');}else{document.getElementById('btn-tab-fil').classList.add('active');document.getElementById('tab-filiacion').classList.add('active');document.getElementById('buscador-persona').value="";document.getElementById('resultados-busqueda').style.display='none';}};
        function limpiarFormulario(p){['nombre','ap1','ap2','doc-num','fecha','tel'].forEach(f=>document.getElementById(`${p}-${f}`).value="");document.getElementById(`${p}-doc-num`).classList.remove('input-error');document.getElementById(`${p}-doc-num`).disabled=false;document.getElementById(`${p}-tipo-doc`).value="DNI";}
        function getDatosFormulario(p){return{nombre:document.getElementById(`${p}-nombre`).value,ap1:document.getElementById(`${p}-ap1`).value,ap2:document.getElementById(`${p}-ap2`).value,tipoDoc:document.getElementById(`${p}-tipo-doc`).value,docNum:document.getElementById(`${p}-doc-num`).value,fechaNac:document.getElementById(`${p}-fecha`).value,telefono:document.getElementById(`${p}-tel`).value};}
        window.abrirModalFamiliar=()=>{limpiarFormulario('fam');document.getElementById('modal-add-familiar').classList.remove('hidden');document.getElementById('fam-tipo-doc').value="MENOR";verificarMenor('fam');};window.cerrarModalFamiliar=()=>document.getElementById('modal-add-familiar').classList.add('hidden');window.guardarFamiliarEnLista=()=>{if(!validarDocumento('fam')||!validarEdad('fam'))return alert("Datos inv√°lidos");const d=getDatosFormulario('fam');if(!d.nombre)return alert("Nombre obligatorio");listaFamiliaresTemp.push(d);actualizarListaFamiliaresUI();cerrarModalFamiliar();};function actualizarListaFamiliaresUI(){const d=document.getElementById('lista-familiares-ui');d.innerHTML="";if(listaFamiliaresTemp.length===0){d.innerHTML='<p style="color:#999;font-style:italic;">Ninguno.</p>';return;}listaFamiliaresTemp.forEach((f,i)=>{d.innerHTML+=`<div class="fam-item"><div><strong>${f.nombre}</strong></div><button class="danger" style="margin:0;padding:2px 8px;width:auto;" onclick="borrarFamiliarTemp(${i})">X</button></div>`;});}window.borrarFamiliarTemp=(i)=>{listaFamiliaresTemp.splice(i,1);actualizarListaFamiliaresUI();};
        window.publicoGuardarTodo=async()=>{if(!validarDocumento('pub')||!validarEdad('pub'))return alert("Revise titular");const p=getDatosFormulario('pub');if(!p.nombre||!p.docNum)return alert("Datos inc.");const famId=new Date().getTime().toString();await addDoc(collection(db,"albergues",currentAlbergueId,"personas"),{...p,estado:'espera',fechaRegistro:new Date(),origen:'qr',familiaId:famId,rolFamilia:'TITULAR'});for(const f of listaFamiliaresTemp)await addDoc(collection(db,"albergues",currentAlbergueId,"personas"),{...f,estado:'espera',fechaRegistro:new Date(),origen:'qr',familiaId:famId,rolFamilia:'MIEMBRO'});document.getElementById('public-form-container').classList.add('hidden');document.getElementById('public-success-msg').classList.remove('hidden');};
        window.abrirModalFamiliarAdmin=()=>{limpiarFormulario('adm-fam');document.getElementById('modal-admin-add-familiar').classList.remove('hidden');document.getElementById('adm-fam-tipo-doc').value="MENOR";verificarMenor('adm-fam');};window.cerrarModalFamiliarAdmin=()=>document.getElementById('modal-admin-add-familiar').classList.add('hidden');window.guardarFamiliarAdmin=()=>{if(!validarDocumento('adm-fam')||!validarEdad('adm-fam'))return alert("Datos inv√°lidos");const d=getDatosFormulario('adm-fam');if(!d.nombre)return alert("Nombre obligatorio");adminFamiliaresTemp.push(d);actualizarListaFamiliaresAdminUI();cerrarModalFamiliarAdmin();};function actualizarListaFamiliaresAdminUI(){const d=document.getElementById('admin-lista-familiares-ui');d.innerHTML="";if(adminFamiliaresTemp.length===0){d.innerHTML='<p style="color:#999;font-style:italic;">Ninguno.</p>';return;}adminFamiliaresTemp.forEach((f,i)=>{d.innerHTML+=`<div class="fam-item"><div><strong>${f.nombre} ${f.ap1}</strong> <small>(${f.docNum})</small></div><button class="danger" style="margin:0;padding:2px 8px;width:auto;" onclick="borrarFamiliarAdminTemp(${i})">X</button></div>`;});}window.borrarFamiliarAdminTemp=(i)=>{adminFamiliaresTemp.splice(i,1);actualizarListaFamiliaresAdminUI();};
        window.adminPrefiliarManual=async()=>{if(!validarEdad('man')||!validarDocumento('man'))return alert("Datos titular inv√°lidos");const t=getDatosFormulario('man');if(!t.nombre)return alert("Falta nombre titular");const famId=new Date().getTime().toString();await addDoc(collection(db,"albergues",currentAlbergueId,"personas"),{...t,estado:'espera',fechaRegistro:new Date(),origen:'manual',familiaId:famId,rolFamilia:'TITULAR'});for(const f of adminFamiliaresTemp){await addDoc(collection(db,"albergues",currentAlbergueId,"personas"),{...f,estado:'espera',fechaRegistro:new Date(),origen:'manual',familiaId:famId,rolFamilia:'MIEMBRO'});}alert("Familia Registrada");limpiarFormulario('man');adminFamiliaresTemp=[];actualizarListaFamiliaresAdminUI();};
        window.abrirModalVincularFamilia=()=>{document.getElementById('modal-vincular-familia').classList.remove('hidden');document.getElementById('search-vincular').value="";document.getElementById('resultados-vincular').innerHTML="";};
        window.buscarParaVincular=()=>{const txt=document.getElementById('search-vincular').value.toLowerCase();const res=document.getElementById('resultados-vincular');res.innerHTML="";if(txt.length<2){res.style.display='none';return;}const hits=listaPersonasCache.filter(p=>p.id!==window.personaEnGestion.id && (p.nombre.toLowerCase().includes(txt)||(p.docNum&&p.docNum.toLowerCase().includes(txt))));if(hits.length===0){res.innerHTML="<div class='search-item' style='color:#999;'>No hay coincidencias.</div>";}else{res.style.display='block';hits.forEach(p=>{const d=document.createElement('div');d.className='search-item';d.innerHTML=`Unir a: <strong>${p.nombre}</strong>`;d.onclick=()=>vincularAFamilia(p);res.appendChild(d);});}};
        window.vincularAFamilia=async(target)=>{if(!confirm(`¬øUnir a ${window.personaEnGestion.nombre} con ${target.nombre}?`))return;let tid=target.familiaId;if(!tid){tid=new Date().getTime().toString()+"-LEGACY";await updateDoc(doc(db,"albergues",currentAlbergueId,"personas",target.id),{familiaId:tid});}await updateDoc(doc(db,"albergues",currentAlbergueId,"personas",window.personaEnGestion.id),{familiaId:tid,rolFamilia:'MIEMBRO'});document.getElementById('modal-vincular-familia').classList.add('hidden');alert("Vinculado.");};
        function cargarUsuarios(){const c=document.getElementById('lista-usuarios-container');unsubscribeUsers=onSnapshot(query(collection(db,"usuarios"),orderBy("nombre")),s=>{c.innerHTML="";s.forEach(d=>{const u=d.data();c.innerHTML+=`<div class="list-item"><strong>${u.nombre}</strong></div>`;});});}
        function cargarAlberguesActivos(){const c=document.getElementById('lista-albergues-activos');unsubscribeAlberguesActivos=onSnapshot(query(collection(db,"albergues"),where("activo","==",true)),s=>{c.innerHTML="";s.forEach(d=>{const a=d.data();c.innerHTML+=`<div class="list-item"><div class="item-info"><strong>${a.nombre}</strong></div><button onclick="entrarAlbergue('${d.id}')">Entrar</button></div>`;});});}
        window.crearUsuario=async()=>{/*...*/};window.abrirCrearUsuario=()=>{document.getElementById('modal-crear-usuario').classList.remove('hidden');};
        window.buscarPersonaEnAlbergue=()=>{const i=document.getElementById('buscador-persona').value.toLowerCase();const r=document.getElementById('resultados-busqueda');if(i.length<2){r.style.display='none';return;}const h=listaPersonasCache.filter(p=>(p.nombre+" "+p.ap1+" "+p.docNum).toLowerCase().includes(i));r.innerHTML="";if(h.length>0){r.style.display='block';h.forEach(p=>{const d=document.createElement('div');d.className='search-item';d.innerHTML=`<strong>${p.nombre} ${p.ap1||''} ${p.ap2||''}</strong> <span class="search-details">üìÑ ${p.docNum||'Sin Doc'} | üìû ${p.telefono||'Sin Tlf'}</span>`;d.onclick=()=>{seleccionarPersona(p);r.style.display='none';document.getElementById('buscador-persona').value="";};r.appendChild(d);});}else r.style.display='none';};
        function seleccionarPersona(p){window.personaEnGestion=p;window.personaSeleccionadaId=p.id;document.getElementById('panel-gestion-persona').classList.remove('hidden');document.getElementById('gestion-nombre-titulo').innerText=p.nombre;document.getElementById('edit-nombre').value=p.nombre;document.getElementById('edit-ap1').value=p.ap1||"";document.getElementById('edit-ap2').value=p.ap2||"";document.getElementById('edit-tipo-doc').value=p.tipoDoc||"DNI";document.getElementById('edit-doc-num').value=p.docNum||"";document.getElementById('edit-fecha').value=p.fechaNac||"";document.getElementById('edit-tel').value=p.telefono||"";verificarMenor('edit');let fid=p.familiaId;if(!fid){fid="Individual (Legacy)";}else{const m=listaPersonasCache.filter(x=>x.familiaId===fid);fid=m.length>1?`${m.length} Miembros`:"Individual";}document.getElementById('info-familia-actual').innerHTML=`<strong>Familia:</strong> ${fid}`;const badge=document.getElementById('gestion-estado');const infoCama=document.getElementById('gestion-cama-info');const btnAs=document.getElementById('btn-asignar-cama');const btnLi=document.getElementById('btn-liberar-cama');const btnRe=document.getElementById('btn-regresar-pref');btnAs.classList.add('hidden');btnLi.classList.add('hidden');btnRe.classList.add('hidden');if(p.estado==='espera'){badge.className='badge badge-archived';badge.innerText="ESPERA";infoCama.innerText="";btnAs.innerText="üõèÔ∏è Ingresar";btnAs.classList.remove('hidden');}else{badge.className='badge badge-active';badge.innerText="DENTRO";if(p.cama){infoCama.innerText=` - Cama: ${p.cama}`;btnAs.innerText="üîÑ Cambiar";btnLi.classList.remove('hidden');}else{infoCama.innerHTML=" - <span style='color:red'>Sin Cama</span>";btnAs.innerText="üõèÔ∏è Asignar";}btnAs.classList.remove('hidden');btnRe.classList.remove('hidden');}}
        window.guardarCambiosPersona=async()=>{if(!window.personaEnGestion)return;if(!validarEdad('edit')||!validarDocumento('edit'))return alert("Datos invalidos");const d=getDatosFormulario('edit');await updateDoc(doc(db,"albergues",currentAlbergueId,"personas",window.personaEnGestion.id),{nombre:d.nombre,ap1:d.ap1,ap2:d.ap2,tipoDoc:d.tipoDoc,docNum:d.docNum,fechaNac:d.fechaNac,telefono:d.telefono});alert("Guardado");};

        window.abrirSeleccionCama=()=>{window.modoMapaGeneral=false;mostrarGridCamas();};window.abrirMapaGeneral=()=>{window.modoMapaGeneral=true;mostrarGridCamas();};
        function mostrarGridCamas(){
            const g=document.getElementById('grid-camas'); g.innerHTML="";
            
            // Format
            const cols = (currentAlbergueData && currentAlbergueData.columnas) ? currentAlbergueData.columnas : 8;
            g.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

            let shadowMap = {}; let famGroups = {};
            listaPersonasCache.forEach(p => { if(p.familiaId) { if(!famGroups[p.familiaId]) famGroups[p.familiaId] = { members:[], beds:[] }; famGroups[p.familiaId].members.push(p); if(p.cama) famGroups[p.familiaId].beds.push(parseInt(p.cama)); } });
            Object.values(famGroups).forEach(fam => {
                let assigned = fam.beds.length; let total = fam.members.length; let needed = total - assigned;
                if(assigned > 0 && needed > 0) {
                    let startBed = Math.max(...fam.beds); let placed = 0; let check = startBed + 1;
                    while(placed < needed && check <= totalCapacidad) { if(!camasOcupadas[check.toString()]) { shadowMap[check.toString()] = fam.members[0].familiaId; placed++; } check++; }
                }
            });
            let myFamId, famMembers=[], assignedMembers=[], neededForMe=1;
            if(!window.modoMapaGeneral && window.personaEnGestion) {
                myFamId = window.personaEnGestion.familiaId;
                if(myFamId) famMembers = listaPersonasCache.filter(m => m.familiaId === myFamId); else famMembers = [window.personaEnGestion];
                assignedMembers = famMembers.filter(m => m.cama && m.id !== window.personaEnGestion.id);
                neededForMe = famMembers.length - assignedMembers.length;
            }

            for(let i=1; i<=totalCapacidad; i++){
                const n = i.toString(); const occupant = listaPersonasCache.find(p => p.cama === n);
                const ocup = occupant ? occupant.nombre : null; const d = document.createElement('div');
                let esMiCama = (!window.modoMapaGeneral && window.personaEnGestion && window.personaEnGestion.cama === n);
                let classes = "bed-box"; let title = "";
                if(esMiCama) { classes += " bed-current"; title = "Tu cama actual"; }
                else if(ocup) { classes += " bed-busy"; }
                else { classes += " bed-free"; title = "Libre"; if(shadowMap[n]) { classes += " bed-shadow"; title = "RESERVADA"; } }
                
                if(!window.modoMapaGeneral && !ocup && !esMiCama) {
                    if(assignedMembers.length > 0) { if(shadowMap[n] === myFamId) classes += " bed-suggest-target"; }
                    else { let fit = true; for(let k=0; k<neededForMe; k++) { if(camasOcupadas[(i+k).toString()]) fit = false; } if(fit && neededForMe > 1) classes += " bed-suggest-block"; }
                }
                d.className = classes; d.innerText = n; d.title = title;
                d.onclick = () => { if(ocup) abrirModalInfoCama(occupant); else if(!window.modoMapaGeneral) guardarCama(n); };
                g.appendChild(d);
            }
            document.getElementById('modal-cama').classList.remove('hidden');
        }

        window.abrirModalInfoCama = (p) => {
            document.getElementById('info-cama-num').innerText = p.cama;
            document.getElementById('info-nombre-completo').innerText = `${p.nombre} ${p.ap1||''} ${p.ap2||''}`;
            document.getElementById('info-telefono').innerText = p.telefono || "No consta";
            const famMembers = listaPersonasCache.filter(m => m.familiaId === p.familiaId);
            const famTag = document.getElementById('info-familia-tag');
            if(famMembers.length > 1) { famTag.style.display = 'inline-block'; famTag.innerText = `Familia de ${famMembers.length} Miembros`; } else { famTag.style.display = 'none'; }
            document.getElementById('modal-bed-info').classList.remove('hidden');
        };

        async function guardarCama(c){await updateDoc(doc(db,"albergues",currentAlbergueId,"personas",window.personaEnGestion.id),{estado:'ingresado',cama:c,fechaIngreso:new Date()});document.getElementById('modal-cama').classList.add('hidden');}
        window.liberarCamaMantener=async()=>await updateDoc(doc(db,"albergues",currentAlbergueId,"personas",window.personaEnGestion.id),{cama:null});
        window.regresarPrefiliacion=async()=>await updateDoc(doc(db,"albergues",currentAlbergueId,"personas",window.personaEnGestion.id),{estado:'espera',cama:null});
        function generarQR(){const u=window.location.href.split('?')[0]+`?public_id=${currentAlbergueId}`;document.getElementById("qrcode").innerHTML="";new QRCode(document.getElementById("qrcode"),{text:u,width:100,height:100});}
    </script>
</body>
</html>
